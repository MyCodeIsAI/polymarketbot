<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Discovery - PolymarketBot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .score-bar { transition: width 0.3s ease; }
        .card-hover { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); }
        .scan-progress { background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%); transition: width 0.5s ease; }

        /* Panel locked state */
        .panel-locked {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }
        .panel-locked::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.3);
            border-radius: 0.5rem;
        }
        .panel-locked .lock-overlay {
            display: flex !important;
        }
        .lock-overlay {
            display: none;
            position: absolute;
            inset: 0;
            z-index: 10;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            border-radius: 0.5rem;
        }

        /* Trader row hover effects */
        .trader-row {
            transition: background-color 0.15s ease;
            will-change: background-color;
        }
        .trader-row:hover { background-color: rgba(59, 130, 246, 0.1) !important; }
        .trader-row:hover .wallet-link { color: #60a5fa; }
        .trader-row .score-indicator { transition: none; }
        .trader-row td { vertical-align: middle; }

        /* Score colors */
        .score-excellent { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .score-good { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .score-moderate { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .score-low { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

        /* Tooltip styles */
        .tooltip-trigger { position: relative; cursor: help; }
        .tooltip-trigger .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 50;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            transition: all 0.15s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: 8px;
        }
        .tooltip-trigger:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        /* Activity indicator */
        .activity-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .activity-hot { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .activity-warm { background: #f59e0b; }
        .activity-cold { background: #6b7280; }
        .activity-dead { background: #374151; }

        /* Step indicator */
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .step-active { background: #3b82f6; color: white; }
        .step-complete { background: #10b981; color: white; }
        .step-pending { background: #374151; color: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold text-blue-400">PolymarketBot</h1>
                <div class="flex items-center space-x-2 ml-4 border-l border-gray-700 pl-4">
                    <a href="/" class="text-sm text-gray-400 hover:text-white px-3 py-1 rounded hover:bg-gray-700 transition">Dashboard</a>
                    <a href="/discovery" class="text-sm text-white font-medium px-3 py-1 bg-gray-700 rounded transition flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Discovery
                    </a>
                    <a href="/scanner" class="text-sm text-gray-400 hover:text-white px-3 py-1 rounded hover:bg-gray-700 transition flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        Scanner
                    </a>
                    <a href="/infrastructure" class="text-sm text-gray-400 hover:text-white px-3 py-1 rounded hover:bg-gray-700 transition flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                        </svg>
                        Infrastructure
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <!-- Header with Step Indicator -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-white mb-2">Trader Discovery Pipeline</h2>
            <p class="text-gray-400 mb-4">Find consistently profitable, systematic traders for copy-trading</p>

            <!-- Step Progress Indicator -->
            <div class="flex items-center space-x-4 bg-gray-800/50 rounded-lg p-4">
                <div class="flex items-center">
                    <div id="step1-indicator" class="step-number step-active">1</div>
                    <span class="ml-2 text-sm font-medium text-white">Initial Scan</span>
                </div>
                <div class="flex-1 h-1 bg-gray-700 rounded">
                    <div id="step1-progress" class="h-full bg-blue-500 rounded transition-all" style="width: 0%"></div>
                </div>
                <div class="flex items-center">
                    <div id="step2-indicator" class="step-number step-pending">2</div>
                    <span class="ml-2 text-sm font-medium text-gray-500">Filter Results</span>
                </div>
                <div class="flex-1 h-1 bg-gray-700 rounded">
                    <div id="step2-progress" class="h-full bg-blue-500 rounded transition-all" style="width: 0%"></div>
                </div>
                <div class="flex items-center">
                    <div id="step3-indicator" class="step-number step-pending">3</div>
                    <span class="ml-2 text-sm font-medium text-gray-500">View Traders</span>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- PANEL 1: INITIAL SCAN (UI1) -->
        <!-- ========================================== -->
        <div id="panel-scan" class="bg-gray-800 rounded-lg border border-gray-700 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-semibold text-white flex items-center">
                        <span class="step-number step-active mr-3">1</span>
                        Initial Scan - Configure Collection Parameters
                    </h3>
                    <p class="text-sm text-gray-400 mt-1 ml-11">Set criteria to collect accounts from Polymarket leaderboards</p>
                </div>
                <div id="scan-status" class="hidden">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-600/20 text-blue-400">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        <span id="scan-status-text">Scanning...</span>
                    </span>
                </div>
            </div>

            <!-- Scan Parameters Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                <!-- Max Accounts -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Accounts to Scan</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">How many accounts to scan from leaderboards</div>
                        </span>
                    </div>
                    <input type="number" id="max-accounts" value="500" min="50" max="10000"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-lg font-medium focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>

                <!-- Min Profit -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Minimum P/L ($)</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Only collect accounts with at least this much profit</div>
                        </span>
                    </div>
                    <input type="number" id="min-profit" value="5000" min="0"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-lg font-medium focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>

                <!-- MAX Profit (NEW) -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Maximum P/L ($)</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Drop accounts with MORE than this profit (filter out whales). Leave blank for no limit.</div>
                        </span>
                    </div>
                    <input type="number" id="max-profit" value="" placeholder="No limit" min="0"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-lg font-medium focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>

                <!-- Trades to Scrape -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Trades to Scrape</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">How many trades to fetch per account for analysis</div>
                        </span>
                    </div>
                    <select id="trades-limit" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-lg font-medium focus:border-blue-500 focus:outline-none h-[50px]">
                        <option value="100">100 (Fast)</option>
                        <option value="250">250 (Balanced)</option>
                        <option value="500" selected>500 (Recommended)</option>
                        <option value="1000">1,000 (Thorough)</option>
                    </select>
                </div>

                <!-- MAX Trades (NEW) -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Maximum Trades</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Drop accounts with MORE than this many trades (filter out high-frequency bots). Leave blank for no limit.</div>
                        </span>
                    </div>
                    <input type="number" id="max-trades" value="" placeholder="No limit" min="0"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-lg font-medium focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>

                <!-- Min Trades -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Minimum Trades</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Require accounts to have at least this many trades</div>
                        </span>
                    </div>
                    <input type="number" id="min-trades" value="10" min="1"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-lg font-medium focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>
            </div>

            <!-- Track Profile Views Toggle -->
            <div class="mb-6">
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" id="track-profile-views" checked
                           class="w-5 h-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                    <span class="text-gray-300">Track Profile Views</span>
                    <span class="tooltip-trigger ml-1">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="tooltip-content">Fetch profile view counts after scan. Adds ~0.1s per account. Use to find under-the-radar traders with low visibility.</div>
                    </span>
                </label>
            </div>

            <!-- Category Filter for Scan (UI1) -->
            <div class="mb-6">
                <div class="flex items-center mb-2">
                    <label class="text-sm text-gray-400">Scan Categories (leave all checked for broad scan)</label>
                    <span class="tooltip-trigger ml-1">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="tooltip-content">Select which leaderboard categories to scan. Uncheck categories to focus on specific trader types.</div>
                    </span>
                </div>
                <div class="flex flex-wrap gap-3" id="scan-categories">
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="CRYPTO" checked class="scan-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Crypto</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="POLITICS" checked class="scan-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Politics</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="SPORTS" checked class="scan-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Sports</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="FINANCE" checked class="scan-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Finance</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="ECONOMICS" checked class="scan-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Economics</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="WEATHER" checked class="scan-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Weather</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="TECH" checked class="scan-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Tech</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="CULTURE" checked class="scan-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Culture</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="OVERALL" checked class="scan-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Overall</span>
                    </label>
                </div>
            </div>

            <!-- Hidden file input for loading saved scans -->
            <input type="file" id="load-saved-file" accept=".json" class="hidden">

            <!-- Action Buttons - Clean Grid Layout -->
            <div class="flex flex-col gap-4">
                <!-- Primary Actions Row -->
                <div class="flex items-center justify-between gap-4">
                    <!-- Left: Quick Load Options -->
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-gray-400 font-medium">Quick Load:</span>
                        <div class="relative">
                            <select id="preloaded-list-select" class="appearance-none bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg pl-4 pr-10 py-2.5 cursor-pointer transition border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none">
                                <option value="" disabled selected>Select cached list...</option>
                                <option value="profitable">Profitable Traders</option>
                                <option value="insider">Insider Suspects</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </div>
                        </div>
                        <button id="load-saved-btn" class="px-4 py-2.5 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition flex items-center border border-gray-600">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Load File
                        </button>
                        <button id="save-results-btn" class="hidden px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                            </svg>
                            Save
                        </button>
                    </div>

                    <!-- Right: Scan Actions -->
                    <div class="flex items-center gap-3">
                        <button id="cancel-scan-btn" class="hidden px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-lg transition">
                            Cancel
                        </button>
                        <div class="flex items-center gap-2 px-3 py-1.5 bg-gray-800 rounded-lg border border-gray-700">
                            <span class="text-xs text-gray-400">Run Scan:</span>
                            <button id="run-mass-scan-btn" class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium rounded transition flex items-center" title="Find profitable systematic traders">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <span class="btn-text">Systematic</span>
                            </button>
                            <button id="run-insider-probe-btn" class="px-3 py-1.5 bg-orange-600 hover:bg-orange-500 text-white text-sm font-medium rounded transition flex items-center" title="Detect insider trading patterns">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <span class="btn-text">Insider</span>
                            </button>
                        </div>
                        <button id="start-scan-btn" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold rounded-lg transition flex items-center shadow-lg shadow-blue-600/20">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            Custom Scan
                        </button>
                    </div>
                </div>

                <!-- Help Text -->
                <p class="text-xs text-gray-500">
                    <span class="text-gray-400">Quick Load</span> instantly loads cached results.
                    <span class="text-gray-400">Systematic</span> finds profitable traders with consistent patterns.
                    <span class="text-gray-400">Insider</span> detects suspicious trading behavior.
                    <span class="text-gray-400">Custom Scan</span> uses the parameters above.
                </p>
            </div>

            <!-- Scan Progress -->
            <div id="scan-progress-container" class="hidden mt-6">
                <div class="flex justify-between text-sm mb-2">
                    <span id="progress-step" class="text-gray-400">Initializing...</span>
                    <span id="progress-stats" class="text-gray-400">0 accounts</span>
                </div>
                <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full scan-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- PANEL 2: FILTERING (UI2) - LOCKED UNTIL SCAN COMPLETE -->
        <!-- ========================================== -->
        <div id="panel-filter" class="bg-gray-800 rounded-lg border border-gray-700 p-6 mb-6 panel-locked relative">
            <!-- Lock Overlay -->
            <div class="lock-overlay">
                <div class="text-center">
                    <svg class="w-12 h-12 text-gray-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <p class="text-gray-400">Complete Step 1 to unlock filtering</p>
                </div>
            </div>

            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-semibold text-white flex items-center">
                        <span id="step2-badge" class="step-number step-pending mr-3">2</span>
                        Filter Results
                    </h3>
                    <p class="text-sm text-gray-400 mt-1 ml-11">Apply additional filters to narrow down candidates</p>
                </div>
            </div>

            <!-- Scan Results Summary -->
            <div id="scan-results-summary" class="bg-gray-900/50 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-lg text-white font-medium">
                            <span id="scan-result-count" class="text-2xl font-bold text-blue-400">0</span> accounts found matching your scan criteria
                        </p>
                        <p class="text-sm text-gray-400 mt-1">Now apply filters to find the best systematic traders</p>
                    </div>
                    <button id="reset-to-scan" class="text-sm text-gray-400 hover:text-white">
                        ← Back to Scan
                    </button>
                </div>
            </div>

            <!-- Filter Options - Row 1: Activity & Profitability -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- Activity Filter -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Last Traded</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Only show accounts that have traded within this many days</div>
                        </span>
                    </div>
                    <select id="filter-activity" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="any">Any</option>
                        <option value="1">Today</option>
                        <option value="3">Last 3 days</option>
                        <option value="7" selected>Last 7 days</option>
                        <option value="14">Last 14 days</option>
                        <option value="30">Last 30 days</option>
                    </select>
                </div>

                <!-- P/L per Trade Filter (NEW) -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Min P/L per Trade ($)</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Average profit per trade. Higher = more profitable per trade. Too high may indicate whales.</div>
                        </span>
                    </div>
                    <input type="number" id="filter-min-pnl-per-trade" value="0" min="0" step="10"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white" placeholder="0">
                </div>

                <!-- Max P/L per Trade Filter (NEW) -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Max P/L per Trade ($)</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Filter out whales with very high per-trade profit. Systematic traders usually have moderate P/L per trade.</div>
                        </span>
                    </div>
                    <input type="number" id="filter-max-pnl-per-trade" value="" min="0" step="100"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white" placeholder="No limit">
                </div>

                <!-- Unique Markets Filter -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Max Unique Markets</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Focused strategy - fewer markets = more specialized expertise</div>
                        </span>
                    </div>
                    <input type="number" id="filter-max-markets" value="" placeholder="No limit" min="0"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                </div>
            </div>

            <!-- Filter Options - Row 2: Position & Trade Frequency -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- Avg Position Size Filter (NEW) -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Max Avg Position ($)</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Filter out whales with large average position sizes</div>
                        </span>
                    </div>
                    <select id="filter-max-avg-position" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="any">Any (no limit)</option>
                        <option value="100">Under $100 (small)</option>
                        <option value="500">Under $500</option>
                        <option value="1000">Under $1,000</option>
                        <option value="5000" selected>Under $5,000</option>
                        <option value="10000">Under $10,000</option>
                        <option value="50000">Under $50,000</option>
                    </select>
                </div>

                <!-- Trades per Week Filter (NEW) -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Trades/Week</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Trade frequency. Very high = likely bot. Very low = inactive.</div>
                        </span>
                    </div>
                    <select id="filter-trades-per-week" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="any">Any</option>
                        <option value="1-50">1-50 (conservative)</option>
                        <option value="10-200" selected>10-200 (moderate)</option>
                        <option value="50-500">50-500 (active)</option>
                        <option value="100-1000">100-1000 (very active)</option>
                    </select>
                </div>

                <!-- Account Age Filter (NEW) -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Min Account Age (days)</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Filter out very new accounts without track record</div>
                        </span>
                    </div>
                    <input type="number" id="filter-min-account-age" value="7" min="0"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white" placeholder="7">
                </div>

                <!-- Max Profile Views Filter -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Max Profile Views</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Find hidden gems: exclude popular accounts with high profile views. Leave blank for no limit.</div>
                        </span>
                    </div>
                    <input type="number" id="filter-max-profile-views" value="" min="0" placeholder="No limit"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                </div>

                <!-- Max Drawdown Filter -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Max Drawdown %</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Max peak-to-trough decline. Lower = better risk management. Systematic traders usually have &lt;30% drawdown.</div>
                        </span>
                    </div>
                    <select id="filter-max-drawdown" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="100">Any (no limit)</option>
                        <option value="15">Under 15% (excellent)</option>
                        <option value="25">Under 25% (good)</option>
                        <option value="40" selected>Under 40% (moderate)</option>
                        <option value="60">Under 60% (tolerant)</option>
                    </select>
                </div>

                <!-- Off High Watermark Filter -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Max Off Peak %</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">How far below their peak equity. Accounts up $20K but down $80K in unrealized losses = 400% off peak. Filters out "technically profitable but underwater" accounts.</div>
                        </span>
                    </div>
                    <select id="filter-off-peak" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="100">Any (no limit)</option>
                        <option value="5">Under 5% (at peak)</option>
                        <option value="10">Under 10% (excellent)</option>
                        <option value="25">Under 25% (healthy)</option>
                        <option value="50" selected>Under 50% (moderate)</option>
                    </select>
                </div>
            </div>

            <!-- Filter Options - Row 3: Systematic Trader Signals -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- Win Rate Filter -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Win Rate %</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Percentage of winning trades. Very high (>80%) may indicate luck. Systematic traders usually have 50-70%.</div>
                        </span>
                    </div>
                    <select id="filter-win-rate" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="any">Any</option>
                        <option value="50-100" selected>50%+ (profitable)</option>
                        <option value="55-80">55-80% (sweet spot)</option>
                        <option value="60-75">60-75% (systematic)</option>
                        <option value="45-65">45-65% (consistent)</option>
                    </select>
                </div>

                <!-- Profit Factor Filter -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Min Profit Factor</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Gross profit / gross loss. &gt;1.5 = good edge. &gt;2.0 = excellent. Core indicator of systematic edge.</div>
                        </span>
                    </div>
                    <select id="filter-min-profit-factor" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="0">Any (>1.0)</option>
                        <option value="1.2">≥1.2 (profitable)</option>
                        <option value="1.5" selected>≥1.5 (good edge)</option>
                        <option value="2.0">≥2.0 (strong edge)</option>
                        <option value="3.0">≥3.0 (excellent)</option>
                    </select>
                </div>

                <!-- Sharpe Ratio Filter -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Min Sharpe Ratio</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Risk-adjusted returns. &gt;0.5 = decent. &gt;1.0 = good. &gt;1.5 = excellent. Filters out high-variance gamblers.</div>
                        </span>
                    </div>
                    <select id="filter-min-sharpe" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="0">Any</option>
                        <option value="0.3">≥0.3 (acceptable)</option>
                        <option value="0.5" selected>≥0.5 (decent)</option>
                        <option value="1.0">≥1.0 (good)</option>
                        <option value="1.5">≥1.5 (excellent)</option>
                    </select>
                </div>

                <!-- Top 3 Wins Concentration (Luck Filter) -->
                <div>
                    <div class="flex items-center mb-2">
                        <label class="text-sm text-gray-400">Max Top-3 Wins %</label>
                        <span class="tooltip-trigger ml-1">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">LUCK DETECTOR: % of total profit from top 3 trades. &gt;70% = lucky, not skilled. Systematic traders have distributed profits.</div>
                        </span>
                    </div>
                    <select id="filter-max-top3-concentration" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="100">Any (no limit)</option>
                        <option value="80">≤80% (filter obvious luck)</option>
                        <option value="70" selected>≤70% (recommended)</option>
                        <option value="50">≤50% (well-distributed)</option>
                        <option value="30">≤30% (very systematic)</option>
                    </select>
                </div>
            </div>

            <!-- Filter Options - Row 4: Primary Category Filter -->
            <div class="mb-4">
                <div class="flex items-center mb-2">
                    <label class="text-sm text-gray-400">Primary Category</label>
                    <span class="tooltip-trigger ml-1">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="tooltip-content">Filter by the trader's primary market focus. "Diversified" means no single category dominates (≥60%).</div>
                    </span>
                </div>
                <div class="flex flex-wrap gap-2" id="filter-categories">
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="all" checked class="filter-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded" id="filter-cat-all">
                        <span class="text-sm text-white">All</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="Crypto" class="filter-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Crypto</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="Politics" class="filter-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Politics</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="Sports" class="filter-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Sports</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="Finance" class="filter-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Finance</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="Weather" class="filter-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Weather</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="Tech" class="filter-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Tech</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="Culture" class="filter-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Culture</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-600">
                        <input type="checkbox" value="Diversified" class="filter-category-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-sm text-white">Diversified</span>
                    </label>
                </div>
            </div>

            <!-- Filter Preview Stats -->
            <div class="bg-gray-900/50 rounded-lg p-4 mb-6">
                <div class="grid grid-cols-4 gap-4 text-center">
                    <div>
                        <div class="text-2xl font-bold text-white" id="preview-total">-</div>
                        <div class="text-xs text-gray-500">Total from Scan</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-green-400" id="preview-passing">-</div>
                        <div class="text-xs text-gray-500">Passing Filters</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-red-400" id="preview-filtered">-</div>
                        <div class="text-xs text-gray-500">Filtered Out</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-blue-400" id="preview-pct">-</div>
                        <div class="text-xs text-gray-500">Pass Rate</div>
                    </div>
                </div>
            </div>

            <!-- Skip Filtering Checkbox + Apply Filters Button -->
            <div class="flex items-center justify-between">
                <!-- Skip Filtering Checkbox -->
                <label class="flex items-center cursor-pointer group">
                    <input type="checkbox" id="skip-filtering" class="w-5 h-5 rounded border-gray-600 bg-gray-700 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-gray-800 cursor-pointer">
                    <span class="ml-3 text-gray-400 group-hover:text-white transition">
                        Skip filtering (pass all accounts to viewer)
                    </span>
                    <span class="tooltip-trigger ml-1">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="tooltip-content">Bypass all filters and pass all loaded accounts directly to the account viewer. Useful for insider suspects list where you want to review all flagged accounts.</div>
                    </span>
                </label>

                <!-- Apply Filters Button -->
                <button id="apply-filters-btn" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition flex items-center text-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    Apply Filters & View Traders (<span id="apply-count">0</span>)
                </button>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- PANEL 3: ACCOUNT VIEWER (UI3) - LOCKED UNTIL FILTERS APPLIED -->
        <!-- ========================================== -->
        <div id="panel-accounts" class="bg-gray-800 rounded-lg border border-gray-700 p-6 mb-6 panel-locked relative">
            <!-- Lock Overlay -->
            <div class="lock-overlay">
                <div class="text-center">
                    <svg class="w-12 h-12 text-gray-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <p class="text-gray-400">Complete Step 2 to view traders</p>
                </div>
            </div>

            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-semibold text-white flex items-center">
                        <span id="step3-badge" class="step-number step-pending mr-3">3</span>
                        Discovered Traders
                    </h3>
                    <p class="text-sm text-gray-400 mt-1 ml-11">Review and select traders for copy-trading</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="back-to-filter" class="text-sm text-gray-400 hover:text-white">
                        ← Modify Filters
                    </button>
                    <button id="show-watchlist-btn" class="text-sm text-yellow-400 hover:text-yellow-300 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        Watchlist (<span id="watchlist-count">0</span>)
                    </button>
                    <button id="show-dismissed-btn" class="text-sm text-gray-500 hover:text-red-400 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                        </svg>
                        Dismissed (<span id="dismissed-count">0</span>)
                    </button>
                    <button id="export-csv-btn" class="text-sm text-gray-400 hover:text-white flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Export CSV
                    </button>
                </div>
            </div>

            <!-- Current Filters Summary -->
            <div id="active-filters-bar" class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-3 mb-4 flex items-center justify-between">
                <div class="flex items-center flex-wrap gap-2">
                    <span class="text-sm text-blue-300 font-medium">Active Filters:</span>
                    <span id="active-filters-list" class="text-sm text-blue-200"></span>
                </div>
                <span class="text-sm text-blue-400" id="filtered-result-count">0 traders</span>
            </div>

            <!-- Sorting and Search -->
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                <div class="flex items-center space-x-3">
                    <select id="analyzed-sort" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        <option value="systematic_score">Sort by Score</option>
                        <option value="total_pnl">Sort by PnL</option>
                        <option value="max_drawdown_pct">Sort by Max Drawdown (lowest first)</option>
                        <option value="profit_factor">Sort by Profit Factor</option>
                        <option value="trades_last_7d">Sort by 7d Activity</option>
                        <option value="profile_views">Sort by Profile Views</option>
                        <option value="profile_views_asc">Sort by Profile Views (lowest first)</option>
                        <option value="activity_recency_days">Sort by Last Trade</option>
                        <option value="num_trades">Sort by Total Trades</option>
                    </select>
                    <input type="text" id="wallet-search" placeholder="Search trader..."
                           class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm w-48">
                </div>
                <div class="text-sm text-gray-400">
                    Showing <span id="analyzed-showing">0</span> of <span id="analyzed-total">0</span> accounts
                </div>
            </div>

            <!-- Results Table -->
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 text-left border-b border-gray-700">
                            <th class="pb-3 pl-2 font-medium w-8"></th>
                            <th class="pb-3 font-medium">Trader</th>
                            <th class="pb-3 font-medium">Category</th>
                            <th class="pb-3 font-medium text-right sortable-header cursor-pointer hover:text-white transition" data-sort="systematic_score">
                                <span class="inline-flex items-center justify-end">Score <span class="sort-icon ml-1"></span></span>
                            </th>
                            <th class="pb-3 font-medium text-right sortable-header cursor-pointer hover:text-white transition" data-sort="total_pnl">
                                <span class="inline-flex items-center justify-end">Total PnL <span class="sort-icon ml-1"></span></span>
                            </th>
                            <th class="pb-3 font-medium text-right sortable-header cursor-pointer hover:text-white transition" data-sort="win_rate">
                                <span class="inline-flex items-center justify-end">Win% <span class="sort-icon ml-1"></span></span>
                            </th>
                            <th class="pb-3 font-medium text-right sortable-header cursor-pointer hover:text-white transition" data-sort="max_drawdown_pct" data-sort-invert="true">
                                <span class="inline-flex items-center justify-end">MaxDD <span class="sort-icon ml-1"></span></span>
                            </th>
                            <th class="pb-3 font-medium text-right sortable-header cursor-pointer hover:text-white transition" data-sort="profit_factor">
                                <span class="inline-flex items-center justify-end">PF <span class="sort-icon ml-1"></span></span>
                            </th>
                            <th class="pb-3 font-medium text-right sortable-header cursor-pointer hover:text-white transition" data-sort="num_trades">
                                <span class="inline-flex items-center justify-end">Trades <span class="sort-icon ml-1"></span></span>
                            </th>
                            <th class="pb-3 font-medium text-right sortable-header cursor-pointer hover:text-white transition" data-sort="trades_last_7d">
                                <span class="inline-flex items-center justify-end">7d <span class="sort-icon ml-1"></span></span>
                            </th>
                            <th class="pb-3 font-medium text-right sortable-header cursor-pointer hover:text-white transition" data-sort="unique_markets">
                                <span class="inline-flex items-center justify-end">Mkts <span class="sort-icon ml-1"></span></span>
                            </th>
                            <th class="pb-3 font-medium text-right sortable-header cursor-pointer hover:text-white transition" data-sort="activity_recency_days" data-sort-invert="true">
                                <span class="inline-flex items-center justify-end">Last <span class="sort-icon ml-1"></span></span>
                            </th>
                            <th class="pb-3 font-medium text-right sortable-header cursor-pointer hover:text-white transition" data-sort="profile_views">
                                <span class="inline-flex items-center justify-end">Views <span class="sort-icon ml-1"></span></span>
                            </th>
                            <th class="pb-3 font-medium text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="analyzed-accounts-table" class="divide-y divide-gray-700">
                        <!-- Dynamically populated -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-center mt-4 space-x-2">
                <button id="prev-page-btn" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm disabled:opacity-50" disabled>
                    ← Prev
                </button>
                <span id="page-info" class="text-sm text-gray-400">Page 1</span>
                <button id="next-page-btn" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm">
                    Next →
                </button>
            </div>
        </div>

        <!-- Watchlist Panel (hidden by default) -->
        <div id="watchlist-panel" class="hidden bg-gray-800 rounded-lg border border-yellow-500/30 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-yellow-400 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    Watchlist (<span id="watchlist-count-panel">0</span>)
                </h3>
                <button id="close-watchlist-btn" class="text-gray-400 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="watchlist-content" class="overflow-x-auto max-h-96 overflow-y-auto">
                <p class="text-gray-400 text-sm">No accounts in watchlist yet. Click the star icon on any trader to add.</p>
            </div>
        </div>

        <!-- Dismissed Panel (hidden traders) -->
        <div id="dismissed-panel" class="hidden bg-gray-800 rounded-lg border border-red-500/30 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-red-400 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                    </svg>
                    Dismissed (<span id="dismissed-count-panel">0</span>)
                </h3>
                <button id="close-dismissed-btn" class="text-gray-400 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="dismissed-content" class="overflow-x-auto max-h-96 overflow-y-auto">
                <p class="text-gray-400 text-sm">No dismissed accounts. Click the X icon on any trader to dismiss.</p>
            </div>
        </div>

        <!-- Account Detail Modal -->
        <div id="detail-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="flex items-center justify-between p-6 border-b border-gray-700 flex-shrink-0">
                    <div>
                        <div class="flex items-center gap-3">
                            <h3 id="modal-username" class="text-lg font-bold text-white"></h3>
                        </div>
                        <div id="modal-wallet" class="text-sm text-gray-400 font-mono mt-1"></div>
                        <div id="modal-score-badge" class="mt-2"></div>
                    </div>
                    <button id="close-modal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 min-h-0">
                    <!-- Overview Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-700 rounded-lg p-4">
                            <div class="text-gray-400 text-xs mb-1">Total Trades</div>
                            <div id="modal-total-trades" class="text-xl font-bold text-white">-</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <div class="text-gray-400 text-xs mb-1">Total P/L</div>
                            <div id="modal-total-pnl" class="text-xl font-bold text-white">-</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <div class="text-gray-400 text-xs mb-1">Win Rate</div>
                            <div id="modal-win-rate" class="text-xl font-bold text-white">-</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <div class="text-gray-400 text-xs mb-1">Max Drawdown</div>
                            <div id="modal-max-dd" class="text-xl font-bold text-white">-</div>
                        </div>
                    </div>

                    <!-- P/L Analysis -->
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">P/L Analysis</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Profit Factor</div>
                                <div id="modal-profit-factor" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Sharpe Ratio</div>
                                <div id="modal-sharpe" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Avg Win</div>
                                <div id="modal-avg-win" class="text-lg font-bold text-green-400">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Avg Loss</div>
                                <div id="modal-avg-loss" class="text-lg font-bold text-red-400">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">P/L per Trade</div>
                                <div id="modal-pnl-per-trade" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Curve Smoothness</div>
                                <div id="modal-smoothness" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Gross Profit</div>
                                <div id="modal-gross-profit" class="text-lg font-bold text-green-400">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Gross Loss</div>
                                <div id="modal-gross-loss" class="text-lg font-bold text-red-400">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Position Sizing -->
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">Position Sizing</h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Avg Position</div>
                                <div id="modal-avg-position" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Max Position</div>
                                <div id="modal-max-position" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Consistency</div>
                                <div id="modal-position-consistency" class="text-lg font-bold text-white">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Metrics -->
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">Risk Metrics</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Max Drawdown</div>
                                <div id="modal-max-dd-detail" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Avg Drawdown</div>
                                <div id="modal-avg-dd" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Current DD</div>
                                <div id="modal-current-dd" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">DD Count (&gt;5%)</div>
                                <div id="modal-dd-count" class="text-lg font-bold text-white">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Analysis -->
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">Activity Analysis</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Last 7 Days</div>
                                <div id="modal-7d-trades" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Last 30 Days</div>
                                <div id="modal-30d-trades" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Last Trade</div>
                                <div id="modal-last-trade" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Trades/Week</div>
                                <div id="modal-trades-per-week" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Unique Markets</div>
                                <div id="modal-unique-markets" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Account Age</div>
                                <div id="modal-account-age" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Wins / Losses</div>
                                <div id="modal-win-loss-count" class="text-lg font-bold text-white">-</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-gray-400 text-xs">Buy/Sell Ratio</div>
                                <div id="modal-buy-sell-ratio" class="text-lg font-bold text-white">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Actions -->
                <div class="flex items-center justify-between p-6 border-t border-gray-700 bg-gray-800 flex-shrink-0">
                    <div class="flex items-center space-x-4">
                        <button id="modal-watchlist" class="flex items-center text-gray-400 hover:text-yellow-400 transition">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                            Add to Watchlist
                        </button>
                    </div>
                    <a id="modal-polymarket-link" href="#" target="_blank" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition">
                        View on Polymarket
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Preset Scan Modal -->
    <div id="preset-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl w-full max-w-lg">
            <div class="flex items-center justify-between p-6 border-b border-gray-700">
                <h3 id="preset-modal-title" class="text-lg font-bold text-white">Load Preset Scan</h3>
                <button id="close-preset-modal" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <!-- Instructions -->
                <div class="mb-4 p-3 bg-gray-700/50 rounded-lg text-sm text-gray-300">
                    <p class="font-medium text-white mb-1">How it works:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Use Cached:</strong> Instantly load previous scan results (fast)</li>
                        <li><strong>Run Fresh:</strong> Execute new scan and update cache (slow but current)</li>
                    </ul>
                </div>

                <!-- Cache Info -->
                <div id="preset-cache-info" class="mb-6 p-4 bg-gray-700 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-400">Cached Results</span>
                        <span id="preset-cache-status" class="text-sm font-medium text-emerald-400">Available</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-400">Accounts:</span>
                            <span id="preset-cache-count" class="text-white ml-1 font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Generated:</span>
                            <span id="preset-cache-date" class="text-white ml-1">-</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button id="preset-use-cache-btn" class="flex-1 px-4 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Use Cached
                    </button>
                    <button id="preset-run-fresh-btn" class="flex-1 px-4 py-3 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-lg transition flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Run Fresh Scan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================================
        // State Management
        // =====================================================================
        let currentScanId = null;
        let scanPollInterval = null;
        let rawScanResults = [];  // Results from scan (before UI2 filtering)
        let filteredAccounts = []; // Results after UI2 filtering (for UI3)
        let currentPage = 1;
        let pageSize = 50;
        let currentSort = 'systematic_score';
        let sortDirection = 'desc';
        let currentModalAccount = null;
        let watchlist = JSON.parse(localStorage.getItem('discovery_watchlist') || '[]');
        let dismissed = [];  // Will be loaded from API
        let usernameCache = {};
        let categoryCache = {};  // wallet -> { primary_category, category_breakdown }
        let categorizationInProgress = false;

        // Panel state tracking
        let panelState = {
            scan: 'active',      // active, complete
            filter: 'locked',    // locked, active, complete
            accounts: 'locked'   // locked, active
        };

        // =====================================================================
        // DOM Elements
        // =====================================================================
        const startScanBtn = document.getElementById('start-scan-btn');
        const cancelScanBtn = document.getElementById('cancel-scan-btn');
        const scanStatus = document.getElementById('scan-status');
        const scanStatusText = document.getElementById('scan-status-text');
        const progressContainer = document.getElementById('scan-progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressStep = document.getElementById('progress-step');
        const progressStats = document.getElementById('progress-stats');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');

        // =====================================================================
        // Category Classification Helper
        // =====================================================================
        function classifyCategory(categoryBreakdown) {
            if (!categoryBreakdown || Object.keys(categoryBreakdown).length === 0) {
                return 'Diversified';
            }

            // Combine economics into finance
            const combined = {};
            for (const [cat, pct] of Object.entries(categoryBreakdown)) {
                const catLower = cat.toLowerCase();
                if (catLower === 'economics') {
                    combined['finance'] = (combined['finance'] || 0) + pct;
                } else {
                    combined[catLower] = (combined[catLower] || 0) + pct;
                }
            }

            // Find dominant category
            let topCat = null;
            let topPct = 0;
            for (const [cat, pct] of Object.entries(combined)) {
                if (pct > topPct) {
                    topPct = pct;
                    topCat = cat;
                }
            }

            // If below 60% threshold, they're diversified
            if (topPct < 0.6) {
                return 'Diversified';
            }

            // Map to display name
            const displayNames = {
                'crypto': 'Crypto',
                'politics': 'Politics',
                'sports': 'Sports',
                'finance': 'Finance',
                'weather': 'Weather',
                'tech': 'Tech',
                'culture': 'Culture',
            };
            return displayNames[topCat] || topCat.charAt(0).toUpperCase() + topCat.slice(1);
        }

        // =====================================================================
        // Lazy Categorization
        // =====================================================================
        async function lazyCategorizeAccounts(accounts) {
            // Filter accounts that need categorization (no category_breakdown or placeholder category)
            const needsCategorization = accounts.filter(a => {
                const wallet = (a.wallet_address || a.wallet || '').toLowerCase();
                // Skip if already categorized and in cache
                if (categoryCache[wallet]) return false;
                // Skip if has valid category breakdown
                if (a.category_breakdown && Object.keys(a.category_breakdown).length > 0) return false;
                // Needs categorization if no category or placeholder category
                const placeholderCategories = ['Diversified', 'Unknown', 'Other', 'other', ''];
                if (!a.primary_category || placeholderCategories.includes(a.primary_category)) return true;
                return false;
            });

            if (needsCategorization.length === 0 || categorizationInProgress) return;

            // Batch categorize (max 20 at a time)
            const batch = needsCategorization.slice(0, 20);
            const wallets = batch.map(a => a.wallet_address || a.wallet);

            console.log(`[Categorization] Lazily categorizing ${wallets.length} accounts...`);
            categorizationInProgress = true;

            try {
                const response = await fetch('/api/discovery/categorize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wallet_addresses: wallets,
                        sample_trades: 50
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log(`[Categorization] Got results for ${data.categorized} accounts`);

                    // Update cache and accounts
                    for (const [wallet, result] of Object.entries(data.results)) {
                        const walletLower = wallet.toLowerCase();
                        categoryCache[walletLower] = result;

                        // Update the account in rawScanResults and filteredAccounts
                        for (const arr of [rawScanResults, filteredAccounts]) {
                            const account = arr.find(a => (a.wallet_address || a.wallet || '').toLowerCase() === walletLower);
                            if (account) {
                                account.primary_category = result.primary_category;
                                account.category_breakdown = result.category_breakdown;
                                account.category_concentration = result.category_concentration;
                            }
                        }
                    }

                    // Re-render the table to show updated categories
                    renderAnalyzedTable();
                }
            } catch (error) {
                console.error('[Categorization] Failed:', error);
            } finally {
                categorizationInProgress = false;
            }
        }

        // =====================================================================
        // Data Normalization - Handle both scan results and pre-analyzed formats
        // =====================================================================
        function normalizeAccountData(accounts, source = 'unknown') {
            console.log(`[Normalize] Processing ${accounts.length} accounts from ${source}`);

            return accounts.map(acc => {
                // Determine format and normalize
                const isPreAnalyzed = 'wallet' in acc && !('wallet_address' in acc);
                const isScanResult = 'wallet_address' in acc && 'pl_metrics' in acc;

                if (isPreAnalyzed) {
                    // Pre-analyzed format - compute missing derived fields
                    const numTrades = acc.num_trades || 0;
                    const accountAgeDays = acc.account_age_days || 30;
                    const tradesPerWeek = acc.trades_per_week || 0;
                    const tradesPerDay = tradesPerWeek / 7;

                    // Compute trades_last_7d and trades_last_30d if missing
                    const tradesLast7d = acc.trades_last_7d !== undefined ? acc.trades_last_7d :
                        Math.min(numTrades, Math.round(tradesPerDay * Math.min(7, accountAgeDays)));
                    const tradesLast30d = acc.trades_last_30d !== undefined ? acc.trades_last_30d :
                        Math.min(numTrades, Math.round(tradesPerDay * Math.min(30, accountAgeDays)));

                    // Compute position_consistency if missing
                    let positionConsistency = acc.position_consistency;
                    if (positionConsistency === undefined || positionConsistency === 0) {
                        const avgPos = parseFloat(acc.avg_position || acc.avg_position_size || 0);
                        const maxPos = parseFloat(acc.max_position || 0);
                        if (avgPos > 0 && maxPos > 0) {
                            // Estimate consistency: 1 - (max - avg) / max
                            positionConsistency = Math.max(0, Math.min(1, 1 - (maxPos - avgPos) / maxPos));
                        } else {
                            positionConsistency = 0.5; // Default neutral value
                        }
                    }

                    // Handle special profit_factor values for display
                    // 999 means infinite (no losses) - keep as-is, modal handles display

                    // Estimate current_drawdown if missing (assume not in drawdown if PnL positive)
                    const currentDrawdown = acc.current_drawdown_pct !== undefined ? acc.current_drawdown_pct :
                        (acc.total_pnl > 0 ? 0 : acc.max_drawdown_pct || 0);

                    return {
                        ...acc,
                        wallet_address: acc.wallet || acc.wallet_address,
                        trades_last_7d: tradesLast7d,
                        trades_last_30d: tradesLast30d,
                        position_consistency: positionConsistency,
                        current_drawdown_pct: currentDrawdown,
                        drawdown_count: acc.drawdown_count || 0,
                        pl_curve_smoothness: acc.pl_curve_smoothness || 0,
                        _source: 'pre-analyzed'
                    };
                } else if ('insider_score' in acc) {
                    // Insider probe format - has wallet_address and insider_score but no pl_metrics
                    const accountAgeDays = acc.account_age_days || 30;
                    const numTrades = acc.total_trades || 0;
                    const winRate = acc.win_rate || 0;
                    const resolvedBets = acc.resolved_bets || 0;

                    // Estimate win/loss counts from resolved bets and win rate
                    const winCount = resolvedBets > 0 ? Math.round(resolvedBets * winRate) : 0;
                    const lossCount = resolvedBets - winCount;

                    // Estimate trades per day and recent activity
                    const tradesPerDay = accountAgeDays > 0 ? numTrades / accountAgeDays : 0;
                    const tradesLast7d = acc.trades_in_last_24h !== undefined
                        ? acc.trades_in_last_24h * 7
                        : Math.min(numTrades, Math.round(tradesPerDay * Math.min(7, accountAgeDays)));
                    const tradesLast30d = Math.min(numTrades, Math.round(tradesPerDay * Math.min(30, accountAgeDays)));

                    // Estimate activity recency (if trades in last 24h > 0, they're active)
                    let activityRecencyDays = accountAgeDays;
                    if (acc.trades_in_last_24h > 0) activityRecencyDays = 0;
                    else if (tradesLast7d > 0) activityRecencyDays = 3;
                    else if (tradesLast30d > 0) activityRecencyDays = 15;

                    // Position metrics from cumulative/largest position
                    const maxPosition = acc.single_largest_position || acc.cumulative_position || 0;
                    const avgPosition = numTrades > 0 ? (acc.cumulative_position || 0) / Math.max(1, acc.unique_markets || 1) : 0;

                    // Estimate profit factor if we have enough data
                    // For insider suspects, perfect win rate often means infinity (no losses)
                    let profitFactor = 0;
                    if (winRate >= 1.0 && resolvedBets > 0) {
                        profitFactor = 999;  // Infinity placeholder
                    } else if (lossCount > 0 && winCount > 0) {
                        // Rough estimate: assume avg win = avg loss for simplicity
                        profitFactor = winCount / Math.max(1, lossCount);
                    }

                    return {
                        wallet: acc.wallet_address,
                        wallet_address: acc.wallet_address,
                        systematic_score: acc.insider_score || 0,  // Map insider_score to systematic_score
                        total_pnl: parseFloat(acc.total_pnl) || 0,
                        num_trades: numTrades,
                        unique_markets: acc.unique_markets || 0,
                        // Insider probe doesn't have drawdown data, estimate from priority
                        max_drawdown_pct: 0,
                        avg_drawdown_pct: 0,
                        estimated_drawdown_pct: 0,
                        win_rate: winRate,
                        profit_factor: profitFactor,
                        sharpe_ratio: 0,  // Not available in insider probe
                        sortino_ratio: 0,
                        // Account age fields
                        account_age_days: accountAgeDays,
                        activity_recency_days: activityRecencyDays,
                        // Activity metrics
                        trades_per_week: tradesPerDay * 7,
                        trades_last_7d: tradesLast7d,
                        trades_last_30d: tradesLast30d,
                        // Position metrics
                        avg_position_size: avgPosition,
                        avg_position: avgPosition,
                        max_position: maxPosition,
                        median_position: avgPosition,
                        pnl_per_trade: numTrades > 0 ? (parseFloat(acc.total_pnl) || 0) / numTrades : 0,
                        // Win/loss metrics
                        avg_win_size: 0,
                        avg_loss_size: 0,
                        profitable_trades: winCount,
                        losing_trades: lossCount,
                        resolved_bets: resolvedBets,
                        gross_profit: 0,
                        gross_loss: 0,
                        // Buy/sell ratio
                        buy_sell_ratio: 0.5,  // Not available
                        // Category
                        primary_category: acc.primary_category || 'Unknown',
                        category_concentration: acc.category_concentration || 0,
                        // Insider-specific fields
                        insider_score: acc.insider_score || 0,
                        priority: acc.priority || 'low',
                        signals: acc.signals || [],
                        signal_count: acc.signal_count || 0,
                        dimensions_active: acc.dimensions_active || 0,
                        dimension_scores: acc.dimension_scores || {},
                        confidence_interval: acc.confidence_interval || [0, 0],
                        avg_entry_odds: acc.avg_entry_odds || 0,
                        has_hedging: acc.has_hedging || false,
                        trades_in_last_24h: acc.trades_in_last_24h || 0,
                        trades_in_off_hours: acc.trades_in_off_hours || 0,
                        cumulative_position: acc.cumulative_position || 0,
                        single_largest_position: acc.single_largest_position || 0,
                        _source: 'insider-probe',
                        _raw: acc  // Keep original for debugging
                    };
                } else if (isScanResult) {
                    // Convert scan result format to pre-analyzed format
                    const pl = acc.pl_metrics || {};
                    const pattern = acc.pattern_metrics || {};
                    const numTrades = pattern.total_trades || 0;
                    // IMPORTANT: Prefer leaderboard P/L (acc.total_pnl) over computed P/L (pl.total_realized_pnl)
                    // The computed P/L is often inaccurate due to incomplete trade history in lookback window
                    const totalPnl = parseFloat(acc.total_pnl || acc.leaderboard_pnl || pl.total_realized_pnl || 0);
                    const accountAgeDays = pattern.account_age_days || 30;
                    const tradesPerDay = pattern.trades_per_day_avg || 0;
                    const winRate = pl.win_rate || 0;

                    // Use actual win/loss counts from API (with fallback estimation)
                    const winCount = pl.win_count !== undefined ? pl.win_count : Math.round(numTrades * winRate);
                    const lossCount = pl.loss_count !== undefined ? pl.loss_count : (numTrades - winCount);

                    // Use days_since_last_trade from API (with fallback)
                    let daysSinceLastTrade = pattern.days_since_last_trade;
                    if (daysSinceLastTrade === undefined || daysSinceLastTrade === null) {
                        // Fallback: try to compute from recent_trades_sample
                        daysSinceLastTrade = accountAgeDays;
                        const recentTrades = acc.recent_trades_sample || [];
                        if (recentTrades.length > 0) {
                            let latestTs = null;
                            for (const trade of recentTrades) {
                                const ts = trade.timestamp ? new Date(trade.timestamp) : null;
                                if (ts && (!latestTs || ts > latestTs)) {
                                    latestTs = ts;
                                }
                            }
                            if (latestTs) {
                                daysSinceLastTrade = Math.floor((Date.now() - latestTs.getTime()) / (1000 * 60 * 60 * 24));
                            }
                        }
                    }

                    // Use buy_sell_ratio from API (with fallback)
                    let buySellRatio = pattern.buy_sell_ratio;
                    if (buySellRatio === undefined || buySellRatio === null) {
                        buySellRatio = 0.5;
                        const recentTrades = acc.recent_trades_sample || [];
                        if (recentTrades.length > 0) {
                            const buyCount = recentTrades.filter(t => t.side === 'BUY').length;
                            buySellRatio = buyCount / recentTrades.length;
                        }
                    }

                    // Estimate recent trade counts based on trades per day
                    const tradesLast7d = Math.min(numTrades, Math.round(tradesPerDay * Math.min(7, accountAgeDays)));
                    const tradesLast30d = Math.min(numTrades, Math.round(tradesPerDay * Math.min(30, accountAgeDays)));

                    // Get gross profit/loss from API
                    const grossProfit = parseFloat(pl.gross_profit || 0);
                    const grossLoss = parseFloat(pl.gross_loss || 0);

                    return {
                        wallet: acc.wallet_address,
                        wallet_address: acc.wallet_address,
                        systematic_score: acc.composite_score || 0,
                        total_pnl: totalPnl,
                        num_trades: numTrades,
                        unique_markets: pattern.unique_markets_traded || 0,
                        max_drawdown_pct: pl.max_drawdown_pct || 0,
                        avg_drawdown_pct: pl.avg_drawdown_pct || 0,
                        off_high_watermark_pct: pl.off_high_watermark_pct || 0,
                        unrealized_pnl: pl.unrealized_pnl || 0,
                        win_rate: winRate,
                        profit_factor: pl.profit_factor || 0,
                        sharpe_ratio: pl.sharpe_ratio || 0,
                        sortino_ratio: pl.sortino_ratio || 0,
                        // Account age fields
                        account_age_days: accountAgeDays,
                        activity_recency_days: daysSinceLastTrade,  // Days since LAST trade
                        // Activity metrics
                        trades_per_week: tradesPerDay * 7,
                        trades_last_7d: tradesLast7d,
                        trades_last_30d: tradesLast30d,
                        // Position and P/L metrics - map from API response
                        avg_position_size: parseFloat(pattern.avg_position_size_usd || 0),
                        avg_position: parseFloat(pattern.avg_position_size_usd || 0),
                        max_position: parseFloat(pattern.max_position_size_usd || 0),
                        median_position: parseFloat(pattern.median_position_size_usd || 0),
                        pnl_per_trade: numTrades > 0 ? totalPnl / numTrades : 0,
                        // Win/loss metrics - map from pl_metrics
                        avg_win_size: parseFloat(pl.avg_win_size || 0),
                        avg_loss_size: parseFloat(pl.avg_loss_size || 0),
                        profitable_trades: winCount,
                        losing_trades: lossCount,
                        gross_profit: grossProfit,
                        gross_loss: grossLoss,
                        // Buy/sell ratio
                        buy_sell_ratio: buySellRatio,
                        // Streaks and additional P/L metrics
                        longest_win_streak: pl.longest_win_streak || 0,
                        longest_loss_streak: pl.longest_loss_streak || 0,
                        current_streak: pl.current_streak || 0,
                        largest_win_pct: pl.largest_win_pct_of_total || 0,
                        top_3_wins_pct_of_total: pl.top_3_wins_pct_of_total || 0,
                        // Position consistency (estimate from std dev)
                        position_consistency: pattern.position_size_std_dev ?
                            Math.max(0, 1 - parseFloat(pattern.position_size_std_dev) / Math.max(1, parseFloat(pattern.avg_position_size_usd || 1))) : 0.5,
                        // Primary category classification
                        primary_category: pattern.primary_category || classifyCategory(pattern.category_breakdown),
                        category_concentration: pattern.category_concentration || 0,
                        category_breakdown: pattern.category_breakdown || {},
                        // Flags
                        red_flag_count: acc.red_flag_count || 0,
                        red_flags: acc.red_flags || [],
                        is_currently_active: pattern.active_days > 0 && daysSinceLastTrade < 14,
                        _source: 'scan',
                        _raw: acc  // Keep original for debugging
                    };
                } else {
                    // Unknown format - return as-is with wallet_address
                    return {
                        ...acc,
                        wallet_address: acc.wallet_address || acc.wallet || 'unknown',
                        _source: 'unknown'
                    };
                }
            });
        }

        // =====================================================================
        // Panel State Management
        // =====================================================================
        function updatePanelStates() {
            const panelScan = document.getElementById('panel-scan');
            const panelFilter = document.getElementById('panel-filter');
            const panelAccounts = document.getElementById('panel-accounts');

            // Panel 1 (Scan) - always accessible
            panelScan.classList.remove('panel-locked');

            // Panel 2 (Filter) - locked until scan complete
            if (panelState.filter === 'locked') {
                panelFilter.classList.add('panel-locked');
                document.getElementById('step2-indicator').className = 'step-number step-pending';
                document.getElementById('step2-badge').className = 'step-number step-pending mr-3';
            } else {
                panelFilter.classList.remove('panel-locked');
                document.getElementById('step2-indicator').className = 'step-number step-active';
                document.getElementById('step2-badge').className = 'step-number step-active mr-3';
            }

            // Panel 3 (Accounts) - locked until filters applied
            if (panelState.accounts === 'locked') {
                panelAccounts.classList.add('panel-locked');
                document.getElementById('step3-indicator').className = 'step-number step-pending';
                document.getElementById('step3-badge').className = 'step-number step-pending mr-3';
            } else {
                panelAccounts.classList.remove('panel-locked');
                document.getElementById('step3-indicator').className = 'step-number step-active';
                document.getElementById('step3-badge').className = 'step-number step-active mr-3';
            }

            // Update step 1 indicator
            if (panelState.scan === 'complete') {
                document.getElementById('step1-indicator').className = 'step-number step-complete';
                document.getElementById('step1-progress').style.width = '100%';
            } else {
                document.getElementById('step1-indicator').className = 'step-number step-active';
            }

            // Update step 2 progress
            if (panelState.filter === 'complete' || panelState.accounts === 'active') {
                document.getElementById('step2-indicator').className = 'step-number step-complete';
                document.getElementById('step2-badge').className = 'step-number step-complete mr-3';
                document.getElementById('step2-progress').style.width = '100%';
            }
        }

        function unlockFilterPanel(accountCount) {
            panelState.scan = 'complete';
            panelState.filter = 'active';
            document.getElementById('scan-result-count').textContent = accountCount.toLocaleString();
            updatePanelStates();
            updateFilterPreview();

            // Scroll to filter panel
            document.getElementById('panel-filter').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function unlockAccountsPanel() {
            panelState.filter = 'complete';
            panelState.accounts = 'active';
            updatePanelStates();
            renderAnalyzedTable();

            // Update active filters display
            updateActiveFiltersDisplay();

            // Scroll to accounts panel
            document.getElementById('panel-accounts').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function resetToScanPanel() {
            panelState.scan = 'active';
            panelState.filter = 'locked';
            panelState.accounts = 'locked';
            rawScanResults = [];
            filteredAccounts = [];
            document.getElementById('step1-progress').style.width = '0%';
            document.getElementById('step2-progress').style.width = '0%';
            updatePanelStates();

            document.getElementById('panel-scan').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // =====================================================================
        // Event Listeners
        // =====================================================================
        startScanBtn.addEventListener('click', startScan);
        cancelScanBtn.addEventListener('click', cancelScan);

        // Pre-loaded list dropdown handler
        document.getElementById('preloaded-list-select').addEventListener('change', async (e) => {
            const listType = e.target.value;
            if (listType === 'profitable') {
                await loadPreAnalyzedAccounts('profitable');
            } else if (listType === 'insider') {
                await loadPreAnalyzedAccounts('insider');
            }
            // Reset dropdown after loading
            e.target.value = '';
        });

        // Fetch counts for dropdown on page load (uses fast meta endpoint)
        (async function updatePreloadedCounts() {
            try {
                const select = document.getElementById('preloaded-list-select');

                // Fetch profitable traders count from fast meta endpoint
                const profitableResp = await fetch('/api/discovery/analyzed-accounts/meta');
                const profitableData = await profitableResp.json();
                const profitableCount = profitableData.total_analyzed || 0;

                // Fetch insider suspects count
                const insiderResp = await fetch('/api/discovery/insider-suspects?limit=1');
                const insiderData = await insiderResp.json();
                const insiderCount = insiderData.total || 0;

                // Update dropdown options
                const options = select.querySelectorAll('option');
                options.forEach(opt => {
                    if (opt.value === 'profitable' && profitableCount > 0) {
                        opt.textContent = `Profitable Traders (${profitableCount})`;
                    } else if (opt.value === 'insider' && insiderCount > 0) {
                        opt.textContent = `Insider Suspects (${insiderCount})`;
                    }
                });
            } catch (e) { /* ignore - will use default counts */ }
        })();

        // Preset scan buttons - open modal instead of running directly
        document.getElementById('run-mass-scan-btn').addEventListener('click', () => openPresetModal('mass-scan'));
        document.getElementById('run-insider-probe-btn').addEventListener('click', () => openPresetModal('insider-probe'));

        // Preset modal buttons
        document.getElementById('close-preset-modal').addEventListener('click', closePresetModal);
        document.getElementById('preset-use-cache-btn').addEventListener('click', () => runPresetWithOption(true));
        document.getElementById('preset-run-fresh-btn').addEventListener('click', () => runPresetWithOption(false));

        // Save/Load scan results buttons
        document.getElementById('save-results-btn').addEventListener('click', saveResultsToFile);
        document.getElementById('load-saved-btn').addEventListener('click', () => {
            document.getElementById('load-saved-file').click();
        });
        document.getElementById('load-saved-file').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                loadResultsFromFile(e.target.files[0]);
                e.target.value = ''; // Reset for future loads
            }
        });

        applyFiltersBtn.addEventListener('click', applyFiltersAndUnlock);
        document.getElementById('close-modal').addEventListener('click', closeModal);
        document.getElementById('analyzed-sort').addEventListener('change', (e) => {
            currentSort = e.target.value;
            renderAnalyzedTable();
        });
        document.getElementById('wallet-search').addEventListener('input', renderAnalyzedTable);
        document.getElementById('show-watchlist-btn').addEventListener('click', toggleWatchlist);
        document.getElementById('close-watchlist-btn').addEventListener('click', () => {
            document.getElementById('watchlist-panel').classList.add('hidden');
        });
        document.getElementById('show-dismissed-btn').addEventListener('click', toggleDismissedPanel);
        document.getElementById('close-dismissed-btn').addEventListener('click', () => {
            document.getElementById('dismissed-panel').classList.add('hidden');
        });
        document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
        document.getElementById('reset-to-scan').addEventListener('click', resetToScanPanel);
        document.getElementById('back-to-filter').addEventListener('click', () => {
            panelState.accounts = 'locked';
            updatePanelStates();
            document.getElementById('panel-filter').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        // Filter change listeners - update preview
        // Select dropdowns (all select-based filters)
        ['filter-activity', 'filter-max-avg-position', 'filter-trades-per-week', 'filter-max-drawdown',
         'filter-off-peak', 'filter-win-rate', 'filter-min-profit-factor', 'filter-min-sharpe', 'filter-max-top3-concentration'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', updateFilterPreview);
        });
        // Number inputs
        ['filter-max-markets', 'filter-min-pnl-per-trade', 'filter-max-pnl-per-trade', 'filter-min-account-age', 'filter-max-profile-views'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', updateFilterPreview);
                el.addEventListener('input', updateFilterPreview);
            }
        });

        // Skip filtering checkbox
        document.getElementById('skip-filtering').addEventListener('change', updateFilterPreview);

        // Category filter checkboxes (UI2)
        document.querySelectorAll('.filter-category-checkbox').forEach(cb => {
            cb.addEventListener('change', (e) => {
                // Handle "All" checkbox behavior
                if (e.target.value === 'all') {
                    // If "All" is checked, uncheck others
                    if (e.target.checked) {
                        document.querySelectorAll('.filter-category-checkbox').forEach(other => {
                            if (other.value !== 'all') other.checked = false;
                        });
                    }
                } else {
                    // If any specific category is checked, uncheck "All"
                    if (e.target.checked) {
                        const allCheckbox = document.getElementById('filter-cat-all');
                        if (allCheckbox) allCheckbox.checked = false;
                    } else {
                        // If nothing is selected, recheck "All"
                        const anyChecked = Array.from(document.querySelectorAll('.filter-category-checkbox:checked'))
                            .some(cb => cb.value !== 'all');
                        if (!anyChecked) {
                            const allCheckbox = document.getElementById('filter-cat-all');
                            if (allCheckbox) allCheckbox.checked = true;
                        }
                    }
                }
                updateFilterPreview();
            });
        });

        // Pagination
        document.getElementById('prev-page-btn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderAnalyzedTable();
            }
        });
        document.getElementById('next-page-btn').addEventListener('click', () => {
            const maxPage = Math.ceil(filteredAccounts.length / pageSize);
            if (currentPage < maxPage) {
                currentPage++;
                renderAnalyzedTable();
            }
        });

        // Column header sorting
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', () => {
                const sortField = header.dataset.sort;
                const invertSort = header.dataset.sortInvert === 'true';

                if (currentSort === sortField) {
                    // Toggle direction
                    sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
                } else {
                    // New sort field - default to desc (unless inverted like MaxDD/Last)
                    currentSort = sortField;
                    sortDirection = invertSort ? 'asc' : 'desc';
                }

                currentPage = 1;  // Reset to first page
                updateSortIcons();
                renderAnalyzedTable();
            });
        });

        function updateSortIcons() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                const sortField = header.dataset.sort;
                const iconSpan = header.querySelector('.sort-icon');
                if (!iconSpan) return;

                if (sortField === currentSort) {
                    header.classList.add('text-white');
                    iconSpan.innerHTML = sortDirection === 'desc'
                        ? '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>'
                        : '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"/></svg>';
                } else {
                    header.classList.remove('text-white');
                    iconSpan.innerHTML = '';
                }
            });
        }

        // Initialize sort icons
        updateSortIcons();

        // =====================================================================
        // Scan Functions
        // =====================================================================
        async function startScan() {
            const maxAccounts = parseInt(document.getElementById('max-accounts').value) || 500;
            const minProfit = parseInt(document.getElementById('min-profit').value) || 5000;
            const maxProfit = document.getElementById('max-profit').value ? parseInt(document.getElementById('max-profit').value) : null;
            const tradesLimit = parseInt(document.getElementById('trades-limit').value) || 500;
            const maxTrades = document.getElementById('max-trades').value ? parseInt(document.getElementById('max-trades').value) : null;
            const minTrades = parseInt(document.getElementById('min-trades').value) || 10;
            const trackProfileViews = document.getElementById('track-profile-views').checked;

            // Get selected scan categories from UI1
            const selectedScanCategories = Array.from(document.querySelectorAll('.scan-category-checkbox:checked'))
                .map(cb => cb.value);

            const config = {
                mode: 'wide_net_profitability',
                max_candidates: maxAccounts,
                min_profit: minProfit,
                max_profit: maxProfit,
                trades_limit: tradesLimit,
                max_trades: maxTrades,
                min_trades: minTrades,
                persist_to_db: true,
                categories: selectedScanCategories.length > 0 ? selectedScanCategories : null,
                // CRITICAL: Match mass_scan.py behavior
                min_score_threshold: 0.0,  // Collect ALL accounts - filter in UI later
                max_phase2: maxAccounts,   // Process all candidates through Phase 2
                max_phase3: maxAccounts,   // Process all candidates through Phase 3
                track_profile_views: trackProfileViews,  // Fetch profile view counts
            };

            try {
                startScanBtn.disabled = true;
                startScanBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Starting...';

                const response = await fetch('/api/discovery/scan/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (!response.ok) {
                    const error = await response.json();
                    let errorMsg = 'Failed to start scan';
                    if (error.detail) {
                        if (Array.isArray(error.detail)) {
                            errorMsg = error.detail.map(e => e.msg || JSON.stringify(e)).join(', ');
                        } else if (typeof error.detail === 'string') {
                            errorMsg = error.detail;
                        }
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                currentScanId = data.scan_id;

                // Show progress UI
                scanStatus.classList.remove('hidden');
                progressContainer.classList.remove('hidden');
                cancelScanBtn.classList.remove('hidden');
                startScanBtn.classList.add('hidden');

                // Start polling
                scanPollInterval = setInterval(pollScanStatus, 1000);

            } catch (error) {
                alert('Failed to start scan: ' + error.message);
                resetScanUI();
            }
        }

        async function pollScanStatus() {
            if (!currentScanId) return;

            try {
                const response = await fetch(`/api/discovery/scan/${currentScanId}`);
                const data = await response.json();

                progressBar.style.width = data.progress_pct + '%';
                progressStep.textContent = data.current_step;
                progressStats.textContent = `${data.candidates_found} accounts found`;
                scanStatusText.textContent = data.current_step.substring(0, 40);

                // Update step 1 progress bar
                document.getElementById('step1-progress').style.width = data.progress_pct + '%';

                if (data.status === 'completed' || data.status === 'failed' || data.status === 'cancelled') {
                    clearInterval(scanPollInterval);
                    scanPollInterval = null;

                    if (data.status === 'completed') {
                        // Load results and unlock filter panel
                        await loadScanResults();
                    } else {
                        alert('Scan ' + data.status);
                    }

                    resetScanUI();
                }

            } catch (error) {
                console.error('Failed to poll scan status:', error);
            }
        }

        async function loadScanResults() {
            try {
                // CRITICAL: Use the actual scan results, not the pre-analyzed file
                if (!currentScanId) {
                    console.error('No scan ID available');
                    return;
                }

                console.log(`[Scan ${currentScanId}] Loading scan results...`);

                const response = await fetch(`/api/discovery/scan/${currentScanId}/results?limit=10000&min_score=0`);
                const data = await response.json();

                // The scan results endpoint returns { total, results }
                const results = data.results || [];
                console.log(`[Scan ${currentScanId}] Loaded ${results.length} raw accounts from scan`);

                // Normalize the data format
                rawScanResults = normalizeAccountData(results, `scan-${currentScanId}`);

                // If scan returned very few results, show a message
                if (rawScanResults.length < 5) {
                    const msg = `Scan returned only ${rawScanResults.length} accounts. The scan pipeline filters aggressively through 3 phases. Consider using 'Load Pre-Analyzed' for access to 200+ accounts.`;
                    console.warn(`[Scan ${currentScanId}] ${msg}`);
                    if (rawScanResults.length === 0) {
                        alert(msg);
                    }
                }

                // Show save button and unlock the filter panel
                showSaveButton();
                unlockFilterPanel(rawScanResults.length);

            } catch (error) {
                console.error('Failed to load scan results:', error);
                alert('Failed to load scan results: ' + error.message);
            }
        }

        // Load pre-analyzed accounts (from batch analysis, not from scan)
        // listType: 'profitable' (default) or 'insider'
        async function enrichAccountsWithProfileViews(accounts) {
            // Find accounts missing profile views
            const walletsToEnrich = accounts
                .filter(acc => !acc.profile_views && acc.wallet_address)
                .map(acc => acc.wallet_address);

            if (walletsToEnrich.length === 0) {
                console.log('[Enrich] All accounts already have profile views');
                return;
            }

            console.log(`[Enrich] Fetching profile views for ${walletsToEnrich.length} accounts...`);

            try {
                const response = await fetch('/api/discovery/enrich-profile-views', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(walletsToEnrich)
                });

                if (!response.ok) throw new Error('Failed to fetch profile views');

                const data = await response.json();
                const results = data.results || {};

                // Update accounts with fetched data
                let enrichedCount = 0;
                for (const acc of accounts) {
                    const wallet = (acc.wallet_address || '').toLowerCase();
                    if (wallet && results[wallet]) {
                        acc.profile_views = results[wallet].views || 0;
                        acc.profile_username = results[wallet].username || null;
                        enrichedCount++;
                    }
                }

                console.log(`[Enrich] Updated ${enrichedCount} accounts with profile views`);
            } catch (error) {
                console.warn('[Enrich] Failed to fetch profile views:', error);
            }
        }

        async function bulkCategorizeAccounts(accounts) {
            // Find accounts with placeholder categories
            const placeholderCategories = ['Diversified', 'Unknown', 'Other', 'other', ''];
            const needsCategorization = accounts.filter(acc => {
                const wallet = (acc.wallet_address || '').toLowerCase();
                if (categoryCache[wallet]) return false;
                if (acc.category_breakdown && Object.keys(acc.category_breakdown).length > 0) return false;
                return !acc.primary_category || placeholderCategories.includes(acc.primary_category);
            });

            if (needsCategorization.length === 0) {
                console.log('[Categorize] All accounts already have categories');
                return;
            }

            // Process in batches of 25 to avoid overwhelming the API
            const batchSize = 25;
            let totalCategorized = 0;

            console.log(`[Categorize] Categorizing ${needsCategorization.length} accounts in batches of ${batchSize}...`);

            for (let i = 0; i < needsCategorization.length; i += batchSize) {
                const batch = needsCategorization.slice(i, i + batchSize);
                const wallets = batch.map(acc => acc.wallet_address);

                try {
                    const response = await fetch('/api/discovery/categorize', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            wallet_addresses: wallets,
                            sample_trades: 50
                        })
                    });

                    if (!response.ok) continue;

                    const data = await response.json();
                    const results = data.results || {};

                    // Update accounts and cache
                    for (const [wallet, result] of Object.entries(results)) {
                        const walletLower = wallet.toLowerCase();
                        categoryCache[walletLower] = result;

                        // Find and update account
                        const acc = accounts.find(a => (a.wallet_address || '').toLowerCase() === walletLower);
                        if (acc && result.primary_category) {
                            acc.primary_category = result.primary_category;
                            acc.category_breakdown = result.category_breakdown;
                            acc.category_concentration = result.category_concentration;
                            totalCategorized++;
                        }
                    }

                    console.log(`[Categorize] Batch ${Math.floor(i/batchSize) + 1}: ${Object.keys(results).length} accounts`);

                } catch (error) {
                    console.warn(`[Categorize] Batch ${Math.floor(i/batchSize) + 1} failed:`, error);
                }

                // Small delay between batches
                if (i + batchSize < needsCategorization.length) {
                    await new Promise(r => setTimeout(r, 100));
                }
            }

            console.log(`[Categorize] Done - categorized ${totalCategorized} accounts`);
        }

        async function loadPreAnalyzedAccounts(listType = 'profitable') {
            try {
                const listName = listType === 'insider' ? 'Insider Suspects' : 'Profitable Traders';
                console.log(`[Pre-Loaded] Loading ${listName}...`);

                // Disable dropdown during load
                const select = document.getElementById('preloaded-list-select');
                select.disabled = true;

                // Choose API endpoint based on list type
                const endpoint = listType === 'insider'
                    ? '/api/discovery/insider-suspects?limit=10000'
                    : '/api/discovery/analyzed-accounts?limit=10000';

                const response = await fetch(endpoint);
                const data = await response.json();
                const accounts = data.accounts || [];

                console.log(`[Pre-Loaded] Loaded ${accounts.length} ${listName} (generated: ${data.generated_at})`);

                // Normalize the data format
                rawScanResults = normalizeAccountData(accounts, listType === 'insider' ? 'insider-suspects' : 'pre-analyzed');

                // Enrich with profile views if missing (non-blocking)
                enrichAccountsWithProfileViews(rawScanResults).then(() => {
                    // Re-render table after enrichment to show updated views
                    if (filteredAccounts.length > 0) {
                        renderAnalyzedTable();
                    }
                });

                // Bulk categorize accounts with placeholder categories (non-blocking)
                bulkCategorizeAccounts(rawScanResults).then(() => {
                    // Re-render after categorization
                    if (filteredAccounts.length > 0) {
                        renderAnalyzedTable();
                    }
                });

                // Re-enable dropdown
                select.disabled = false;

                // Skip to filter panel (no scan needed)
                panelState.scan = 'complete';
                document.getElementById('step1-progress').style.width = '100%';
                document.getElementById('step1-indicator').className = 'step-number step-complete';

                // Show save button and unlock filter panel
                showSaveButton();
                unlockFilterPanel(rawScanResults.length);

            } catch (error) {
                console.error('Failed to load pre-loaded accounts:', error);
                alert('Failed to load accounts: ' + error.message);
                // Re-enable dropdown on error
                document.getElementById('preloaded-list-select').disabled = false;
            }
        }

        // =====================================================================
        // Preset Modal Functions
        // =====================================================================

        let currentPresetType = null; // 'mass-scan' or 'insider-probe'

        async function openPresetModal(presetType) {
            currentPresetType = presetType;
            const modal = document.getElementById('preset-modal');
            const title = document.getElementById('preset-modal-title');
            const cacheStatus = document.getElementById('preset-cache-status');
            const cacheCount = document.getElementById('preset-cache-count');
            const cacheDate = document.getElementById('preset-cache-date');
            const useCacheBtn = document.getElementById('preset-use-cache-btn');

            // Set title based on type
            title.textContent = presetType === 'mass-scan' ? 'Mass Scan - Profitable Traders' : 'Insider Probe - Suspicious Accounts';

            // Fetch cache info
            try {
                const response = await fetch('/api/discovery/preset/cache-info');
                const data = await response.json();

                const cacheInfo = presetType === 'mass-scan' ? data.mass_scan : data.insider_probe;

                if (cacheInfo && cacheInfo.exists) {
                    cacheStatus.textContent = 'Available';
                    cacheStatus.className = 'text-sm font-medium text-emerald-400';
                    cacheCount.textContent = cacheInfo.accounts_count.toLocaleString();

                    // Format date nicely
                    const date = new Date(cacheInfo.generated_at);
                    const now = new Date();
                    const diffHours = Math.round((now - date) / (1000 * 60 * 60));

                    if (diffHours < 1) {
                        cacheDate.textContent = 'Just now';
                    } else if (diffHours < 24) {
                        cacheDate.textContent = `${diffHours}h ago`;
                    } else {
                        const diffDays = Math.round(diffHours / 24);
                        cacheDate.textContent = `${diffDays}d ago`;
                    }

                    useCacheBtn.disabled = false;
                    useCacheBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    cacheStatus.textContent = 'No cache available';
                    cacheStatus.className = 'text-sm font-medium text-yellow-400';
                    cacheCount.textContent = '-';
                    cacheDate.textContent = '-';

                    useCacheBtn.disabled = true;
                    useCacheBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } catch (e) {
                console.error('Failed to fetch cache info:', e);
                cacheStatus.textContent = 'Error checking cache';
                cacheStatus.className = 'text-sm font-medium text-red-400';
                cacheCount.textContent = '-';
                cacheDate.textContent = '-';
                useCacheBtn.disabled = true;
                useCacheBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }

            modal.classList.remove('hidden');
        }

        function closePresetModal() {
            document.getElementById('preset-modal').classList.add('hidden');
            currentPresetType = null;
        }

        async function runPresetWithOption(useCache) {
            closePresetModal();

            if (useCache) {
                // Load from cache - use the preloaded accounts function
                const listType = currentPresetType === 'mass-scan' ? 'profitable' : 'insider';
                await loadPreAnalyzedAccounts(listType);
            } else {
                // Run fresh scan
                if (currentPresetType === 'mass-scan') {
                    await runMassScanPreset();
                } else {
                    await runInsiderProbePreset();
                }
            }
        }

        // =====================================================================
        // Preset Scan Functions
        // =====================================================================

        async function runMassScanPreset() {
            const btn = document.getElementById('run-mass-scan-btn');
            const btnText = btn.querySelector('.btn-text');

            if (btn.disabled) return;

            try {
                btn.disabled = true;
                btnText.textContent = 'Starting...';

                const response = await fetch('/api/discovery/preset/mass-scan', { method: 'POST' });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to start scan');
                }

                const scanId = data.scan_id;
                btnText.textContent = 'Running...';

                // Poll for completion
                const pollInterval = setInterval(async () => {
                    try {
                        const statusResp = await fetch(`/api/discovery/preset/${scanId}`);
                        const status = await statusResp.json();

                        if (status.status === 'completed') {
                            clearInterval(pollInterval);
                            btn.disabled = false;
                            btnText.textContent = 'Mass Scan';

                            // Auto-load the results
                            alert(`Mass Scan Complete! Found ${status.accounts_found} profitable traders.\n\nLoading results...`);
                            await loadPreAnalyzedAccounts('profitable');

                            // Update dropdown count
                            const select = document.getElementById('preloaded-list-select');
                            const opt = select.querySelector('option[value="profitable"]');
                            if (opt) opt.textContent = `Profitable Traders (${status.accounts_found})`;

                        } else if (status.status === 'error') {
                            clearInterval(pollInterval);
                            btn.disabled = false;
                            btnText.textContent = 'Mass Scan';
                            alert('Mass Scan Error: ' + (status.error || 'Unknown error'));
                        } else {
                            // Still running
                            btnText.textContent = `${Math.round(status.progress_pct)}%...`;
                        }
                    } catch (e) {
                        console.error('Poll error:', e);
                    }
                }, 3000);

            } catch (error) {
                btn.disabled = false;
                btnText.textContent = 'Mass Scan';
                alert('Failed to start mass scan: ' + error.message);
            }
        }

        async function runInsiderProbePreset() {
            const btn = document.getElementById('run-insider-probe-btn');
            const btnText = btn.querySelector('.btn-text');

            if (btn.disabled) return;

            try {
                btn.disabled = true;
                btnText.textContent = 'Starting...';

                const response = await fetch('/api/discovery/preset/insider-probe', { method: 'POST' });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to start probe');
                }

                const scanId = data.scan_id;
                btnText.textContent = 'Probing...';

                // Poll for completion
                const pollInterval = setInterval(async () => {
                    try {
                        const statusResp = await fetch(`/api/discovery/preset/${scanId}`);
                        const status = await statusResp.json();

                        if (status.status === 'completed') {
                            clearInterval(pollInterval);
                            btn.disabled = false;
                            btnText.textContent = 'Insider Probe';

                            // Auto-load the results
                            alert(`Insider Probe Complete! Flagged ${status.accounts_found} suspect accounts.\n\nLoading results...`);
                            await loadPreAnalyzedAccounts('insider');

                            // Update dropdown count
                            const select = document.getElementById('preloaded-list-select');
                            const opt = select.querySelector('option[value="insider"]');
                            if (opt) opt.textContent = `Insider Suspects (${status.accounts_found})`;

                        } else if (status.status === 'error') {
                            clearInterval(pollInterval);
                            btn.disabled = false;
                            btnText.textContent = 'Insider Probe';
                            alert('Insider Probe Error: ' + (status.error || 'Unknown error'));
                        } else {
                            // Still running
                            btnText.textContent = `${Math.round(status.progress_pct)}%...`;
                        }
                    } catch (e) {
                        console.error('Poll error:', e);
                    }
                }, 3000);

            } catch (error) {
                btn.disabled = false;
                btnText.textContent = 'Insider Probe';
                alert('Failed to start insider probe: ' + error.message);
            }
        }

        // =====================================================================
        // Save/Load Scan Results Functions
        // =====================================================================
        function saveResultsToFile() {
            if (!rawScanResults || rawScanResults.length === 0) {
                alert('No results to save. Run a scan or load pre-analyzed data first.');
                return;
            }

            // Prepare export data
            const exportData = {
                saved_at: new Date().toISOString(),
                source: currentScanId ? `scan-${currentScanId}` : 'pre-analyzed',
                scan_config: {
                    max_accounts: document.getElementById('max-accounts').value,
                    min_profit: document.getElementById('min-profit').value,
                    max_profit: document.getElementById('max-profit').value,
                    trades_limit: document.getElementById('trades-limit').value,
                    max_trades: document.getElementById('max-trades').value,
                    min_trades: document.getElementById('min-trades').value,
                },
                total_accounts: rawScanResults.length,
                accounts: rawScanResults,
            };

            // Generate filename with timestamp
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `polymarket-scan-${timestamp}.json`;

            // Create and download file
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log(`[Save] Exported ${rawScanResults.length} accounts to ${filename}`);
        }

        function loadResultsFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Validate the file format
                    if (!data.accounts || !Array.isArray(data.accounts)) {
                        throw new Error('Invalid file format: missing accounts array');
                    }

                    console.log(`[Load] Loading saved scan from ${data.saved_at || 'unknown date'}`);
                    console.log(`[Load] Source: ${data.source || 'unknown'}, Accounts: ${data.accounts.length}`);

                    // Normalize the data
                    rawScanResults = normalizeAccountData(data.accounts, data.source || 'loaded-file');

                    // Update UI
                    panelState.scan = 'complete';
                    document.getElementById('step1-progress').style.width = '100%';
                    document.getElementById('step1-indicator').className = 'step-number step-complete';

                    // Show save button since we have data
                    document.getElementById('save-results-btn').classList.remove('hidden');

                    // Unlock filter panel
                    unlockFilterPanel(rawScanResults.length);

                    // Show success message
                    console.log(`[Load] Successfully loaded ${rawScanResults.length} accounts from file`);

                } catch (error) {
                    console.error('Failed to parse saved scan file:', error);
                    alert('Failed to load file: ' + error.message);
                }
            };
            reader.onerror = function() {
                alert('Failed to read file');
            };
            reader.readAsText(file);
        }

        // Show save button when results are available
        function showSaveButton() {
            document.getElementById('save-results-btn').classList.remove('hidden');
        }

        async function cancelScan() {
            if (!currentScanId) return;
            try {
                await fetch(`/api/discovery/scan/${currentScanId}/cancel`, { method: 'POST' });
                clearInterval(scanPollInterval);
                resetScanUI();
            } catch (error) {
                console.error('Failed to cancel scan:', error);
            }
        }

        function resetScanUI() {
            startScanBtn.disabled = false;
            startScanBtn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>Start Scan';
            startScanBtn.classList.remove('hidden');
            cancelScanBtn.classList.add('hidden');
            scanStatus.classList.add('hidden');
            progressContainer.classList.add('hidden');
            currentScanId = null;
        }

        // =====================================================================
        // Filter Functions (UI2)
        // =====================================================================
        function updateFilterPreview() {
            if (rawScanResults.length === 0) return;

            const skipFiltering = document.getElementById('skip-filtering').checked;
            const total = rawScanResults.length;

            let passing, filtered, pct;

            if (skipFiltering) {
                // All accounts pass when skip filtering is enabled (except dismissed)
                passing = rawScanResults.filter(account => {
                    const wallet = account.wallet_address || account.wallet;
                    return !dismissed.includes(wallet);
                });
                filtered = total - passing.length;
                pct = total > 0 ? 100 : 0;
            } else {
                passing = applyCurrentFilters(rawScanResults);
                filtered = total - passing.length;
                pct = total > 0 ? Math.round((passing.length / total) * 100) : 0;
            }

            document.getElementById('preview-total').textContent = total.toLocaleString();
            document.getElementById('preview-passing').textContent = passing.length.toLocaleString();
            document.getElementById('preview-filtered').textContent = filtered.toLocaleString();
            document.getElementById('preview-pct').textContent = pct + '%';
            document.getElementById('apply-count').textContent = passing.length.toLocaleString();

            // Update button text based on skip filtering
            const btn = document.getElementById('apply-filters-btn');
            if (skipFiltering) {
                btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>View All Traders (' + passing.length.toLocaleString() + ')';
            } else {
                btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>Apply Filters & View Traders (' + passing.length.toLocaleString() + ')';
            }
        }

        function applyCurrentFilters(accounts) {
            // Get all filter values - Basic filters
            const activityFilter = document.getElementById('filter-activity').value;
            const maxMarketsRaw = document.getElementById('filter-max-markets').value;
            const maxMarkets = maxMarketsRaw ? parseInt(maxMarketsRaw) : null;
            const minPnlPerTrade = parseFloat(document.getElementById('filter-min-pnl-per-trade').value) || 0;
            const maxPnlPerTradeRaw = document.getElementById('filter-max-pnl-per-trade').value;
            const maxPnlPerTrade = maxPnlPerTradeRaw ? parseFloat(maxPnlPerTradeRaw) : null;
            const maxAvgPosition = document.getElementById('filter-max-avg-position').value;
            const tradesPerWeekRange = document.getElementById('filter-trades-per-week').value;
            const minAccountAge = parseInt(document.getElementById('filter-min-account-age').value) || 0;
            const maxProfileViewsRaw = document.getElementById('filter-max-profile-views').value;
            const maxProfileViews = maxProfileViewsRaw ? parseInt(maxProfileViewsRaw) : null;

            // New systematic trader filters
            const maxDrawdown = parseFloat(document.getElementById('filter-max-drawdown').value) || 100;
            const maxOffPeak = parseFloat(document.getElementById('filter-off-peak').value) || 100;
            const winRateRange = document.getElementById('filter-win-rate').value;
            const minProfitFactor = parseFloat(document.getElementById('filter-min-profit-factor').value) || 0;
            const minSharpe = parseFloat(document.getElementById('filter-min-sharpe').value) || 0;
            const maxTop3Concentration = parseFloat(document.getElementById('filter-max-top3-concentration').value) || 100;

            return accounts.filter(account => {
                // Skip dismissed accounts
                const wallet = account.wallet_address || account.wallet;
                if (dismissed.includes(wallet)) return false;

                // Activity filter (last traded X days ago)
                if (activityFilter !== 'any') {
                    const maxDays = parseInt(activityFilter);
                    const recency = account.activity_recency_days ?? account.days_since_last_trade ?? 999;
                    if (recency > maxDays) return false;
                }

                // Max unique markets filter (focused strategy = fewer markets)
                if (maxMarkets !== null) {
                    const markets = account.unique_markets || 0;
                    if (markets > maxMarkets) return false;
                }

                // P/L per trade filters
                const pnlPerTrade = account.pnl_per_trade || (account.total_pnl / (account.num_trades || 1));
                if (pnlPerTrade < minPnlPerTrade) return false;
                if (maxPnlPerTrade !== null && pnlPerTrade > maxPnlPerTrade) return false;

                // Max average position filter (filter out whales)
                if (maxAvgPosition !== 'any') {
                    const maxPos = parseFloat(maxAvgPosition);
                    const avgPos = account.avg_position_size || account.avg_position || 0;
                    if (avgPos > maxPos) return false;
                }

                // Trades per week filter
                if (tradesPerWeekRange !== 'any') {
                    const [minTpw, maxTpw] = tradesPerWeekRange.split('-').map(Number);
                    const tpw = account.trades_per_week || 0;
                    if (tpw < minTpw || tpw > maxTpw) return false;
                }

                // Account age filter
                const accountAge = account.account_age_days || 0;
                if (accountAge < minAccountAge) return false;

                // Max drawdown filter (risk management)
                if (maxDrawdown < 100) {
                    const drawdown = (account.max_drawdown_pct || account.max_drawdown || 0) * 100;
                    if (drawdown > maxDrawdown) return false;
                }

                // Off high watermark filter (how far below peak)
                if (maxOffPeak < 100) {
                    const offPeak = (account.off_high_watermark_pct || 0) * 100;
                    if (offPeak > maxOffPeak) return false;
                }

                // Win rate filter
                if (winRateRange !== 'any') {
                    const [minWr, maxWr] = winRateRange.split('-').map(Number);
                    const winRate = (account.win_rate || 0) * 100;
                    if (winRate < minWr || winRate > maxWr) return false;
                }

                // Profit factor filter (edge indicator)
                if (minProfitFactor > 0) {
                    const pf = account.profit_factor || 0;
                    if (pf < minProfitFactor) return false;
                }

                // Sharpe ratio filter (risk-adjusted returns)
                if (minSharpe > 0) {
                    const sharpe = account.sharpe_ratio || 0;
                    if (sharpe < minSharpe) return false;
                }

                // Top 3 wins concentration filter (luck detector)
                if (maxTop3Concentration < 100) {
                    const top3Pct = (account.top_3_wins_pct_of_total || account.top_3_wins_pct || 0) * 100;
                    if (top3Pct > maxTop3Concentration) return false;
                }

                // Category filter
                const selectedCategories = getSelectedCategories();
                if (selectedCategories.length > 0 && !selectedCategories.includes('all')) {
                    const accountCategory = account.primary_category || 'Diversified';
                    if (!selectedCategories.includes(accountCategory)) return false;
                }

                // Profile views filter (find hidden gems)
                if (maxProfileViews !== null) {
                    const views = account.profile_views || 0;
                    if (views > maxProfileViews) return false;
                }

                return true;
            });
        }

        function getSelectedCategories() {
            const checkboxes = document.querySelectorAll('.filter-category-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function applyFiltersAndUnlock() {
            // Check if skip filtering is enabled
            const skipFiltering = document.getElementById('skip-filtering').checked;

            if (skipFiltering) {
                // Pass all accounts without filtering (except dismissed)
                filteredAccounts = rawScanResults.filter(account => {
                    const wallet = account.wallet_address || account.wallet;
                    return !dismissed.includes(wallet);
                });
                console.log(`[Skip Filtering] Passing all ${filteredAccounts.length} accounts to viewer`);
            } else {
                filteredAccounts = applyCurrentFilters(rawScanResults);
            }

            currentPage = 1;
            unlockAccountsPanel();
        }

        function updateActiveFiltersDisplay() {
            const activityFilter = document.getElementById('filter-activity').value;
            const maxMarkets = document.getElementById('filter-max-markets').value;
            const minPnlPerTrade = document.getElementById('filter-min-pnl-per-trade').value;
            const maxPnlPerTrade = document.getElementById('filter-max-pnl-per-trade').value;
            const maxAvgPosition = document.getElementById('filter-max-avg-position').value;
            const tradesPerWeek = document.getElementById('filter-trades-per-week').value;
            const minAccountAge = document.getElementById('filter-min-account-age').value;
            const maxProfileViews = document.getElementById('filter-max-profile-views').value;
            // New systematic trader filters
            const maxDrawdown = document.getElementById('filter-max-drawdown').value;
            const maxOffPeak = document.getElementById('filter-off-peak').value;
            const winRate = document.getElementById('filter-win-rate').value;
            const minProfitFactor = document.getElementById('filter-min-profit-factor').value;
            const minSharpe = document.getElementById('filter-min-sharpe').value;
            const maxTop3 = document.getElementById('filter-max-top3-concentration').value;

            const filters = [];
            if (activityFilter !== 'any') filters.push(`Traded in ${activityFilter}d`);
            if (maxMarkets) filters.push(`≤${maxMarkets} markets`);
            if (minPnlPerTrade > 0) filters.push(`P/L/trade ≥$${minPnlPerTrade}`);
            if (maxPnlPerTrade) filters.push(`P/L/trade ≤$${maxPnlPerTrade}`);
            if (maxAvgPosition !== 'any') filters.push(`AvgPos ≤$${parseInt(maxAvgPosition).toLocaleString()}`);
            if (tradesPerWeek !== 'any') filters.push(`${tradesPerWeek} trades/wk`);
            if (minAccountAge > 0) filters.push(`${minAccountAge}+ days old`);
            if (maxProfileViews) filters.push(`≤${parseInt(maxProfileViews).toLocaleString()} views`);
            // New systematic trader filter displays
            if (maxDrawdown !== '100') filters.push(`DD ≤${maxDrawdown}%`);
            if (maxOffPeak !== '100') filters.push(`OffPeak ≤${maxOffPeak}%`);
            if (winRate !== 'any') filters.push(`WR ${winRate}%`);
            if (minProfitFactor > 0) filters.push(`PF ≥${minProfitFactor}`);
            if (minSharpe > 0) filters.push(`Sharpe ≥${minSharpe}`);
            if (maxTop3 !== '100') filters.push(`Top3 ≤${maxTop3}%`);
            // Category filter display
            const selectedCats = getSelectedCategories();
            if (selectedCats.length > 0 && !selectedCats.includes('all')) {
                filters.push(`Cat: ${selectedCats.join(', ')}`);
            }

            document.getElementById('active-filters-list').textContent = filters.length > 0 ? filters.join(' | ') : 'None';
            document.getElementById('filtered-result-count').textContent = filteredAccounts.length + ' traders';
        }

        // =====================================================================
        // Render Table (UI3)
        // =====================================================================
        function renderAnalyzedTable() {
            const searchTerm = document.getElementById('wallet-search').value.toLowerCase();

            // Filter by search
            let displayAccounts = filteredAccounts;
            if (searchTerm) {
                displayAccounts = filteredAccounts.filter(a => {
                    const username = usernameCache[a.wallet_address?.toLowerCase()] || '';
                    return (a.wallet_address || '').toLowerCase().includes(searchTerm) ||
                           username.toLowerCase().includes(searchTerm);
                });
            }

            // Sort
            displayAccounts.sort((a, b) => {
                let aVal, bVal;

                switch (currentSort) {
                    case 'systematic_score':
                        aVal = a.systematic_score || 0;
                        bVal = b.systematic_score || 0;
                        break;
                    case 'total_pnl':
                        aVal = parseFloat(a.total_pnl) || 0;
                        bVal = parseFloat(b.total_pnl) || 0;
                        break;
                    case 'win_rate':
                        aVal = a.win_rate || 0;
                        bVal = b.win_rate || 0;
                        break;
                    case 'max_drawdown_pct':
                        aVal = a.max_drawdown_pct || a.estimated_drawdown_pct || 0;
                        bVal = b.max_drawdown_pct || b.estimated_drawdown_pct || 0;
                        return sortDirection === 'desc' ? aVal - bVal : bVal - aVal;
                    case 'num_trades':
                        aVal = a.num_trades || 0;
                        bVal = b.num_trades || 0;
                        break;
                    case 'trades_last_7d':
                        aVal = a.trades_last_7d || 0;
                        bVal = b.trades_last_7d || 0;
                        break;
                    case 'unique_markets':
                        aVal = a.unique_markets || 0;
                        bVal = b.unique_markets || 0;
                        break;
                    case 'activity_recency_days':
                        aVal = a.activity_recency_days ?? 999;
                        bVal = b.activity_recency_days ?? 999;
                        return sortDirection === 'desc' ? aVal - bVal : bVal - aVal;
                    case 'profit_factor':
                        aVal = a.profit_factor || 1;
                        bVal = b.profit_factor || 1;
                        break;
                    case 'profile_views':
                        aVal = a.profile_views || 0;
                        bVal = b.profile_views || 0;
                        break;
                    case 'profile_views_asc':
                        aVal = a.profile_views || 0;
                        bVal = b.profile_views || 0;
                        return aVal - bVal;  // Ascending: lowest first (hidden gems)
                    default:
                        aVal = 0;
                        bVal = 0;
                }

                return sortDirection === 'desc' ? bVal - aVal : aVal - bVal;
            });

            // Paginate
            const startIdx = (currentPage - 1) * pageSize;
            const pageAccounts = displayAccounts.slice(startIdx, startIdx + pageSize);

            // Render
            const tbody = document.getElementById('analyzed-accounts-table');
            tbody.innerHTML = pageAccounts.map((account, idx) => renderTraderRow(account, startIdx + idx + 1)).join('');

            // Trigger lazy categorization for visible accounts (non-blocking)
            lazyCategorizeAccounts(pageAccounts);

            // Update pagination
            const maxPage = Math.ceil(displayAccounts.length / pageSize);
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${maxPage || 1}`;
            document.getElementById('prev-page-btn').disabled = currentPage <= 1;
            document.getElementById('next-page-btn').disabled = currentPage >= maxPage;

            document.getElementById('analyzed-showing').textContent = displayAccounts.length;
            document.getElementById('analyzed-total').textContent = filteredAccounts.length;

            // Add row click handlers
            document.querySelectorAll('.trader-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    if (!e.target.closest('button') && !e.target.closest('a')) {
                        openAccountModal(row.dataset.wallet);
                    }
                });
            });

            // Add watchlist button handlers
            document.querySelectorAll('.watchlist-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleWatchlistItem(btn.dataset.wallet);
                });
            });

            // Add dismiss button handlers
            document.querySelectorAll('.dismiss-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dismissAccount(btn.dataset.wallet);
                });
            });
        }

        function renderTraderRow(account, rank) {
            const wallet = account.wallet_address || account.wallet || '';
            const score = account.systematic_score || 0;
            const pnl = parseFloat(account.total_pnl) || 0;
            const maxDrawdown = account.max_drawdown_pct || account.estimated_drawdown_pct || 0;
            const trades = account.num_trades || 0;
            const trades7d = account.trades_last_7d || 0;
            const recencyDays = account.activity_recency_days ?? 999;

            // Score color class
            let scoreClass = 'score-low';
            if (score >= 90) scoreClass = 'score-excellent';
            else if (score >= 80) scoreClass = 'score-good';
            else if (score >= 65) scoreClass = 'score-moderate';

            // Activity indicator
            let activityClass = 'activity-dead';
            let activityTitle = 'Inactive';
            if (recencyDays <= 1) { activityClass = 'activity-hot'; activityTitle = 'Very active (today)'; }
            else if (recencyDays <= 7) { activityClass = 'activity-warm'; activityTitle = 'Active (7d)'; }
            else if (recencyDays <= 30) { activityClass = 'activity-cold'; activityTitle = 'Moderate (30d)'; }

            // PnL formatting
            const pnlStr = pnl >= 1000000 ? `$${(pnl/1000000).toFixed(1)}M` :
                           pnl >= 1000 ? `$${(pnl/1000).toFixed(0)}k` : `$${pnl.toFixed(0)}`;
            const pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';

            // Drawdown color
            let ddColor = 'text-green-400';
            if (maxDrawdown > 25) ddColor = 'text-red-400';
            else if (maxDrawdown > 15) ddColor = 'text-orange-400';
            else if (maxDrawdown > 8) ddColor = 'text-yellow-400';

            // Recency string
            let recencyStr = recencyDays === 0 ? 'today' :
                            recencyDays === 1 ? '1d ago' :
                            recencyDays < 999 ? `${recencyDays}d ago` : '-';

            // Is in watchlist
            const inWatchlist = watchlist.includes(wallet);

            // Wallet display
            const shortWallet = wallet ? `${wallet.substring(0, 6)}...${wallet.substring(38)}` : '-';

            // Win rate color
            const winRate = account.win_rate || 0;
            // Check if this is an unrealized gains account (has PnL but no realized trades)
            const hasUnrealizedOnly = winRate === 0 && pnl > 1000 && (account.profitable_trades || 0) === 0;
            const winRateDisplay = hasUnrealizedOnly ? 'Hold' : (winRate > 0 ? (winRate * 100).toFixed(0) + '%' : '-');
            let winRateColor = 'text-gray-400';
            if (hasUnrealizedOnly) winRateColor = 'text-cyan-400';  // Cyan for buy-and-hold
            else if (winRate >= 0.6) winRateColor = 'text-green-400';
            else if (winRate >= 0.5) winRateColor = 'text-blue-400';
            else if (winRate > 0) winRateColor = 'text-yellow-400';

            // Profit factor
            const profitFactor = account.profit_factor || 0;
            // Handle 999 (infinity placeholder for no losses)
            const pfDisplay = profitFactor >= 999 ? '∞' : (profitFactor > 0 ? profitFactor.toFixed(1) : '-');
            let pfColor = 'text-gray-400';
            if (profitFactor >= 999) pfColor = 'text-purple-400';  // Infinity = purple
            else if (profitFactor >= 2) pfColor = 'text-green-400';
            else if (profitFactor >= 1.5) pfColor = 'text-blue-400';
            else if (profitFactor >= 1) pfColor = 'text-yellow-400';
            else if (profitFactor > 0) pfColor = 'text-red-400';

            // Markets
            const uniqueMarkets = account.unique_markets || 0;

            // Profile views
            const profileViews = account.profile_views || 0;
            let viewsStr = '-';
            let viewsColor = 'text-gray-500';
            if (profileViews > 0) {
                viewsStr = profileViews >= 1000000 ? `${(profileViews/1000000).toFixed(1)}M` :
                           profileViews >= 1000 ? `${(profileViews/1000).toFixed(0)}k` : profileViews.toLocaleString();
                if (profileViews < 1000) viewsColor = 'text-green-400';  // Hidden gem
                else if (profileViews < 10000) viewsColor = 'text-blue-400';
                else if (profileViews < 100000) viewsColor = 'text-yellow-400';
                else viewsColor = 'text-orange-400';  // Very popular
            }

            // Primary category
            const primaryCategory = account.primary_category || 'Diversified';
            const categoryColors = {
                'Crypto': 'bg-orange-600/30 text-orange-400',
                'Politics': 'bg-blue-600/30 text-blue-400',
                'Sports': 'bg-green-600/30 text-green-400',
                'Finance': 'bg-emerald-600/30 text-emerald-400',
                'Weather': 'bg-cyan-600/30 text-cyan-400',
                'Tech': 'bg-purple-600/30 text-purple-400',
                'Culture': 'bg-pink-600/30 text-pink-400',
                'Diversified': 'bg-gray-600/30 text-gray-400',
            };
            const categoryColor = categoryColors[primaryCategory] || categoryColors['Diversified'];

            return `
                <tr class="trader-row cursor-pointer hover:bg-gray-700/50" data-wallet="${wallet}">
                    <td class="py-3 pl-2">
                        <span class="activity-dot ${activityClass}" title="${activityTitle}"></span>
                    </td>
                    <td class="py-3">
                        <div class="flex items-center">
                            <span class="wallet-link text-sm text-gray-300 font-mono">${shortWallet}</span>
                            ${inWatchlist ? '<svg class="w-4 h-4 ml-2 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>' : ''}
                        </div>
                    </td>
                    <td class="py-3">
                        <span class="px-2 py-0.5 rounded text-xs font-medium ${categoryColor}">${primaryCategory}</span>
                    </td>
                    <td class="py-3 text-right">
                        <span class="score-indicator inline-flex items-center justify-center w-10 h-8 rounded ${scoreClass} text-white font-bold text-sm">
                            ${score.toFixed(0)}
                        </span>
                    </td>
                    <td class="py-3 text-right ${pnlColor} font-medium">${pnlStr}</td>
                    <td class="py-3 text-right ${winRateColor} text-sm">${winRateDisplay}</td>
                    <td class="py-3 text-right ${ddColor} text-sm">${maxDrawdown.toFixed(1)}%</td>
                    <td class="py-3 text-right ${pfColor} text-sm">${pfDisplay}</td>
                    <td class="py-3 text-right text-gray-300">${trades.toLocaleString()}</td>
                    <td class="py-3 text-right">
                        <span class="${trades7d > 0 ? 'text-cyan-400 font-medium' : 'text-gray-500'}">${trades7d}</span>
                    </td>
                    <td class="py-3 text-right text-gray-400">${uniqueMarkets}</td>
                    <td class="py-3 text-right text-gray-400 text-xs">${recencyStr}</td>
                    <td class="py-3 text-right ${viewsColor} text-xs">${viewsStr}</td>
                    <td class="py-3">
                        <div class="flex items-center justify-center gap-1">
                            <button class="watchlist-btn p-1.5 rounded hover:bg-gray-600 transition ${inWatchlist ? 'text-yellow-400' : 'text-gray-500 hover:text-yellow-400'}"
                                    data-wallet="${wallet}" title="${inWatchlist ? 'Remove from watchlist' : 'Add to watchlist'}">
                                <svg class="w-4 h-4" fill="${inWatchlist ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                </svg>
                            </button>
                            <button class="dismiss-btn p-1.5 rounded hover:bg-gray-600 text-gray-500 hover:text-red-400 transition"
                                    data-wallet="${wallet}" title="Dismiss (hide from results)">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            <a href="https://polymarket.com/profile/${wallet}" target="_blank"
                               class="p-1.5 rounded hover:bg-gray-600 text-gray-500 hover:text-purple-400 transition" title="View on Polymarket">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </td>
                </tr>
            `;
        }

        // =====================================================================
        // Modal Functions
        // =====================================================================
        function openAccountModal(walletAddress) {
            const account = filteredAccounts.find(a => (a.wallet_address || a.wallet) === walletAddress) ||
                           rawScanResults.find(a => (a.wallet_address || a.wallet) === walletAddress);
            if (!account) return;

            currentModalAccount = account;
            const wallet = account.wallet_address || account.wallet;

            document.getElementById('modal-username').textContent = `Trader ${wallet.substring(0, 8)}...`;
            document.getElementById('modal-wallet').textContent = wallet;

            const score = account.systematic_score || 0;
            const scoreColor = score >= 90 ? 'bg-green-500/20 text-green-400' :
                              score >= 80 ? 'bg-blue-500/20 text-blue-400' :
                              score >= 65 ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400';
            document.getElementById('modal-score-badge').innerHTML = `<span class="px-3 py-1 rounded-full text-sm font-medium ${scoreColor}">Score: ${score.toFixed(0)}</span>`;

            // Overview Stats
            document.getElementById('modal-total-trades').textContent = (account.num_trades || 0).toLocaleString();
            const pnl = parseFloat(account.total_pnl) || 0;
            document.getElementById('modal-total-pnl').textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('modal-total-pnl').className = 'text-xl font-bold ' + (pnl >= 0 ? 'text-green-400' : 'text-red-400');

            const winRate = account.win_rate;
            const pnlPositive = (parseFloat(account.total_pnl) || 0) > 1000;
            const isUnrealized = winRate === 0 && pnlPositive && (account.profitable_trades || 0) === 0;
            if (isUnrealized) {
                // Account has P/L but no realized trades (buy-and-hold strategy)
                document.getElementById('modal-win-rate').textContent = 'Unrealized';
                document.getElementById('modal-win-rate').title = 'This trader has unrealized gains - positions not yet sold';
            } else {
                document.getElementById('modal-win-rate').textContent = winRate != null ? ((winRate) * 100).toFixed(1) + '%' : 'N/A';
            }

            const maxDD = account.max_drawdown_pct || account.estimated_drawdown_pct || 0;
            document.getElementById('modal-max-dd').textContent = maxDD.toFixed(1) + '%';

            // P/L Analysis
            const profitFactor = account.profit_factor || 0;
            // Handle profit_factor = 999 (infinity placeholder for no losses)
            if (profitFactor >= 999) {
                document.getElementById('modal-profit-factor').textContent = '∞';
                document.getElementById('modal-profit-factor').title = 'No realized losses';
            } else if (profitFactor > 0) {
                document.getElementById('modal-profit-factor').textContent = profitFactor.toFixed(2) + 'x';
            } else {
                document.getElementById('modal-profit-factor').textContent = isUnrealized ? 'Unrealized' : 'N/A';
            }

            const sharpe = account.sharpe_ratio || 0;
            document.getElementById('modal-sharpe').textContent = sharpe !== 0 ? sharpe.toFixed(3) : 'N/A';

            const avgWin = account.avg_win_size || 0;
            document.getElementById('modal-avg-win').textContent = avgWin > 0 ? '$' + avgWin.toLocaleString(undefined, {maximumFractionDigits: 0}) : '$0';

            const avgLoss = account.avg_loss_size || 0;
            // Show $0 if no losses (loss_count = 0), N/A only if data missing
            const hasLossData = account.losing_trades !== undefined || account.loss_count !== undefined;
            document.getElementById('modal-avg-loss').textContent = avgLoss > 0 ? '$' + avgLoss.toLocaleString(undefined, {maximumFractionDigits: 0}) : (hasLossData ? '$0' : 'N/A');

            const pnlPerTrade = account.pnl_per_trade || 0;
            document.getElementById('modal-pnl-per-trade').textContent = '$' + pnlPerTrade.toLocaleString(undefined, {maximumFractionDigits: 0});

            const smoothness = account.pl_curve_smoothness || 0;
            document.getElementById('modal-smoothness').textContent = (smoothness * 100).toFixed(0) + '%';

            const grossProfit = account.gross_profit || 0;
            if (grossProfit > 0) {
                document.getElementById('modal-gross-profit').textContent = '$' + grossProfit.toLocaleString(undefined, {maximumFractionDigits: 0});
            } else if (isUnrealized) {
                document.getElementById('modal-gross-profit').textContent = 'Unrealized';
                document.getElementById('modal-gross-profit').title = 'Profits not yet realized (positions held)';
            } else {
                document.getElementById('modal-gross-profit').textContent = '$0';
            }

            const grossLoss = account.gross_loss || 0;
            document.getElementById('modal-gross-loss').textContent = '$' + grossLoss.toLocaleString(undefined, {maximumFractionDigits: 0});

            // Position Sizing
            const avgPos = account.avg_position || account.avg_position_size || 0;
            document.getElementById('modal-avg-position').textContent = '$' + avgPos.toLocaleString(undefined, {maximumFractionDigits: 0});

            const maxPos = account.max_position || 0;
            document.getElementById('modal-max-position').textContent = '$' + maxPos.toLocaleString(undefined, {maximumFractionDigits: 0});

            const posConsistency = account.position_consistency || 0;
            document.getElementById('modal-position-consistency').textContent = (posConsistency * 100).toFixed(0) + '%';

            // Risk Metrics
            document.getElementById('modal-max-dd-detail').textContent = maxDD.toFixed(1) + '%' + (account.max_drawdown_usd ? ' ($' + account.max_drawdown_usd.toLocaleString(undefined, {maximumFractionDigits: 0}) + ')' : '');

            const avgDD = account.avg_drawdown_pct || 0;
            document.getElementById('modal-avg-dd').textContent = avgDD.toFixed(1) + '%';

            const currentDD = account.current_drawdown_pct || 0;
            document.getElementById('modal-current-dd').textContent = currentDD > 0 ? currentDD.toFixed(1) + '%' : 'None';
            document.getElementById('modal-current-dd').className = 'text-lg font-bold ' + (currentDD > 10 ? 'text-red-400' : currentDD > 5 ? 'text-yellow-400' : 'text-green-400');

            const ddCount = account.drawdown_count || 0;
            document.getElementById('modal-dd-count').textContent = ddCount;

            // Activity
            document.getElementById('modal-7d-trades').textContent = account.trades_last_7d || 0;
            document.getElementById('modal-30d-trades').textContent = account.trades_last_30d || 0;

            const recency = account.activity_recency_days;
            document.getElementById('modal-last-trade').textContent = recency === 0 ? 'Today' :
                                                                       recency === 1 ? '1 day ago' :
                                                                       recency < 999 ? `${recency} days ago` : 'N/A';

            const tradesPerWeek = account.trades_per_week || 0;
            document.getElementById('modal-trades-per-week').textContent = tradesPerWeek.toFixed(1);

            const uniqueMarkets = account.unique_markets || 0;
            document.getElementById('modal-unique-markets').textContent = uniqueMarkets;

            const accountAge = account.account_age_days || 0;
            document.getElementById('modal-account-age').textContent = accountAge > 365 ? Math.floor(accountAge/365) + 'y' : accountAge + 'd';

            const wins = account.profitable_trades || 0;
            const losses = account.losing_trades || 0;
            document.getElementById('modal-win-loss-count').textContent = `${wins} / ${losses}`;

            const buySellRatio = account.buy_sell_ratio || 0.5;
            document.getElementById('modal-buy-sell-ratio').textContent = (buySellRatio * 100).toFixed(0) + '% buy';

            // Polymarket link
            document.getElementById('modal-polymarket-link').href = `https://polymarket.com/profile/${wallet}`;

            // Watchlist button
            updateModalWatchlistButton(wallet);
            document.getElementById('modal-watchlist').onclick = () => toggleWatchlistItem(wallet);

            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
            currentModalAccount = null;
        }

        function updateModalWatchlistButton(wallet) {
            const btn = document.getElementById('modal-watchlist');
            const inWatchlist = watchlist.includes(wallet);
            btn.innerHTML = inWatchlist ?
                '<svg class="w-5 h-5 mr-1" fill="currentColor" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>Remove from Watchlist' :
                '<svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>Add to Watchlist';
            btn.className = `flex items-center transition ${inWatchlist ? 'text-yellow-400' : 'text-gray-400 hover:text-yellow-400'}`;
        }

        // =====================================================================
        // Watchlist/Dismissed Panel Helpers
        // =====================================================================
        function renderAccountTable(wallets, mode) {
            // mode: 'watchlist' or 'dismissed'
            const categoryColors = {
                'Crypto': 'bg-orange-600/30 text-orange-400',
                'Politics': 'bg-blue-600/30 text-blue-400',
                'Sports': 'bg-green-600/30 text-green-400',
                'Finance': 'bg-emerald-600/30 text-emerald-400',
                'Weather': 'bg-cyan-600/30 text-cyan-400',
                'Tech': 'bg-purple-600/30 text-purple-400',
                'Culture': 'bg-pink-600/30 text-pink-400',
                'Diversified': 'bg-gray-600/30 text-gray-400',
                'Other': 'bg-gray-600/30 text-gray-400',
            };

            const rows = wallets.map(wallet => {
                const account = rawScanResults.find(a => (a.wallet_address || a.wallet) === wallet);
                if (!account) {
                    // Account not in raw results - show minimal info
                    return `
                        <tr class="panel-row cursor-pointer hover:bg-gray-700/50" data-wallet="${wallet}">
                            <td class="py-2 px-2">
                                <span class="text-sm text-gray-300 font-mono">${wallet.substring(0, 8)}...${wallet.substring(38)}</span>
                            </td>
                            <td class="py-2 text-gray-500 text-sm" colspan="9">Account data not loaded</td>
                            <td class="py-2">
                                <div class="flex items-center justify-center gap-1">
                                    ${mode === 'watchlist' ? `
                                        <button class="panel-remove-btn p-1.5 rounded hover:bg-gray-600 text-red-400 hover:text-red-300 transition" data-wallet="${wallet}" title="Remove from watchlist">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                        </button>
                                    ` : `
                                        <button class="panel-restore-btn p-1.5 rounded hover:bg-gray-600 text-green-400 hover:text-green-300 transition" data-wallet="${wallet}" title="Restore">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                                        </button>
                                    `}
                                    <a href="https://polymarket.com/profile/${wallet}" target="_blank" class="p-1.5 rounded hover:bg-gray-600 text-gray-500 hover:text-purple-400 transition" title="View on Polymarket">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    `;
                }

                const shortWallet = wallet.substring(0, 8) + '...' + wallet.substring(38);
                const score = account.systematic_score || account.insider_score || 0;
                const scoreClass = score >= 90 ? 'bg-green-600' : score >= 80 ? 'bg-blue-600' : score >= 65 ? 'bg-yellow-600' : 'bg-red-600';

                const pnl = parseFloat(account.total_pnl) || 0;
                const pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                const pnlStr = (pnl >= 0 ? '+$' : '-$') + Math.abs(pnl).toLocaleString(undefined, {maximumFractionDigits: 0});

                const winRate = account.win_rate;
                const winRateDisplay = winRate != null ? (winRate * 100).toFixed(1) + '%' : '-';
                const winRateColor = winRate >= 0.6 ? 'text-green-400' : winRate >= 0.5 ? 'text-yellow-400' : 'text-red-400';

                const maxDrawdown = account.max_drawdown_pct || 0;
                const ddColor = maxDrawdown <= 10 ? 'text-green-400' : maxDrawdown <= 25 ? 'text-yellow-400' : 'text-red-400';

                const profitFactor = account.profit_factor || 0;
                const pfDisplay = profitFactor > 10 ? '10+' : profitFactor.toFixed(2);
                const pfColor = profitFactor >= 2 ? 'text-green-400' : profitFactor >= 1.5 ? 'text-yellow-400' : 'text-red-400';

                const trades = account.num_trades || 0;
                const uniqueMarkets = account.unique_markets || 0;

                const primaryCategory = account.primary_category || 'Other';
                const categoryColor = categoryColors[primaryCategory] || categoryColors['Other'];

                return `
                    <tr class="panel-row cursor-pointer hover:bg-gray-700/50" data-wallet="${wallet}">
                        <td class="py-2 px-2">
                            <span class="text-sm text-gray-300 font-mono">${shortWallet}</span>
                        </td>
                        <td class="py-2">
                            <span class="px-2 py-0.5 rounded text-xs font-medium ${categoryColor}">${primaryCategory}</span>
                        </td>
                        <td class="py-2 text-right">
                            <span class="inline-flex items-center justify-center w-10 h-7 rounded ${scoreClass} text-white font-bold text-sm">${score.toFixed(0)}</span>
                        </td>
                        <td class="py-2 text-right ${pnlColor} font-medium">${pnlStr}</td>
                        <td class="py-2 text-right ${winRateColor} text-sm">${winRateDisplay}</td>
                        <td class="py-2 text-right ${ddColor} text-sm">${maxDrawdown.toFixed(1)}%</td>
                        <td class="py-2 text-right ${pfColor} text-sm">${pfDisplay}</td>
                        <td class="py-2 text-right text-gray-300">${trades.toLocaleString()}</td>
                        <td class="py-2 text-right text-gray-400">${uniqueMarkets}</td>
                        <td class="py-2">
                            <div class="flex items-center justify-center gap-1">
                                ${mode === 'watchlist' ? `
                                    <button class="panel-remove-btn p-1.5 rounded hover:bg-gray-600 text-red-400 hover:text-red-300 transition" data-wallet="${wallet}" title="Remove from watchlist">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                ` : `
                                    <button class="panel-restore-btn p-1.5 rounded hover:bg-gray-600 text-green-400 hover:text-green-300 transition" data-wallet="${wallet}" title="Restore">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                                    </button>
                                `}
                                <a href="https://polymarket.com/profile/${wallet}" target="_blank" class="p-1.5 rounded hover:bg-gray-600 text-gray-500 hover:text-purple-400 transition" title="View on Polymarket" onclick="event.stopPropagation();">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <table class="w-full text-left text-gray-400 text-sm">
                    <thead class="text-xs uppercase border-b border-gray-700">
                        <tr>
                            <th class="pb-2 px-2">Trader</th>
                            <th class="pb-2">Category</th>
                            <th class="pb-2 text-right">Score</th>
                            <th class="pb-2 text-right">PnL</th>
                            <th class="pb-2 text-right">Win%</th>
                            <th class="pb-2 text-right">DD</th>
                            <th class="pb-2 text-right">PF</th>
                            <th class="pb-2 text-right">Trades</th>
                            <th class="pb-2 text-right">Mkts</th>
                            <th class="pb-2 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700/50">
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        function attachPanelRowHandlers(mode) {
            const containerId = mode === 'watchlist' ? 'watchlist-content' : 'dismissed-content';
            const container = document.getElementById(containerId);

            // Row click to open modal
            container.querySelectorAll('.panel-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    // Don't open modal if clicking action buttons
                    if (e.target.closest('button') || e.target.closest('a')) return;
                    const wallet = row.dataset.wallet;
                    openAccountModal(wallet);
                });
            });

            // Remove/restore button handlers
            if (mode === 'watchlist') {
                container.querySelectorAll('.panel-remove-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const wallet = btn.dataset.wallet;
                        toggleWatchlistItem(wallet);
                        renderWatchlist();
                    });
                });
            } else {
                container.querySelectorAll('.panel-restore-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const wallet = btn.dataset.wallet;
                        undismissAccount(wallet);
                    });
                });
            }
        }

        // =====================================================================
        // Watchlist Functions
        // =====================================================================
        function toggleWatchlistItem(wallet) {
            const idx = watchlist.indexOf(wallet);
            if (idx >= 0) {
                watchlist.splice(idx, 1);
            } else {
                watchlist.push(wallet);
            }
            localStorage.setItem('discovery_watchlist', JSON.stringify(watchlist));
            document.getElementById('watchlist-count').textContent = watchlist.length;
            document.getElementById('watchlist-count-panel').textContent = watchlist.length;

            // Re-render table to update star icons
            renderAnalyzedTable();

            // Update modal if open
            if (currentModalAccount && (currentModalAccount.wallet_address === wallet || currentModalAccount.wallet === wallet)) {
                updateModalWatchlistButton(wallet);
            }
        }

        function toggleWatchlist() {
            const panel = document.getElementById('watchlist-panel');
            panel.classList.toggle('hidden');

            if (!panel.classList.contains('hidden')) {
                renderWatchlist();
            }
        }

        function renderWatchlist() {
            const container = document.getElementById('watchlist-content');
            document.getElementById('watchlist-count-panel').textContent = watchlist.length;

            if (watchlist.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No accounts in watchlist yet. Click the star icon on any trader to add.</p>';
                return;
            }

            container.innerHTML = renderAccountTable(watchlist, 'watchlist');
            attachPanelRowHandlers('watchlist');
        }

        // =====================================================================
        // Dismissed Functions
        // =====================================================================
        async function dismissAccount(wallet) {
            try {
                await fetch(`/api/discovery/dismissed/${wallet}`, { method: 'POST' });
                if (!dismissed.includes(wallet)) {
                    dismissed.push(wallet);
                }
                // Remove from filtered results
                filteredAccounts = filteredAccounts.filter(a => (a.wallet_address || a.wallet) !== wallet);
                updateDismissedCount();
                renderAnalyzedTable();
            } catch (error) {
                console.error('Failed to dismiss account:', error);
            }
        }

        async function undismissAccount(wallet) {
            try {
                await fetch(`/api/discovery/dismissed/${wallet}`, { method: 'DELETE' });
                dismissed = dismissed.filter(w => w !== wallet);
                updateDismissedCount();
                renderDismissedPanel();
                // Re-apply filters to potentially show the account again
                filteredAccounts = applyCurrentFilters(rawScanResults);
                renderAnalyzedTable();
            } catch (error) {
                console.error('Failed to undismiss account:', error);
            }
        }

        function toggleDismissedPanel() {
            const panel = document.getElementById('dismissed-panel');
            panel.classList.toggle('hidden');

            if (!panel.classList.contains('hidden')) {
                renderDismissedPanel();
            }
        }

        function renderDismissedPanel() {
            const container = document.getElementById('dismissed-content');
            document.getElementById('dismissed-count-panel').textContent = dismissed.length;

            if (dismissed.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No dismissed accounts. Click the X icon on any trader to dismiss.</p>';
                return;
            }

            container.innerHTML = renderAccountTable(dismissed, 'dismissed');
            attachPanelRowHandlers('dismissed');
        }

        function updateDismissedCount() {
            document.getElementById('dismissed-count').textContent = dismissed.length;
            document.getElementById('dismissed-count-panel').textContent = dismissed.length;
        }

        async function loadUserPrefs() {
            try {
                const response = await fetch('/api/discovery/user-prefs');
                const data = await response.json();
                dismissed = data.dismissed || [];
                updateDismissedCount();
                console.log('[UserPrefs] Loaded', data.watchlist_count, 'watchlist,', data.dismissed_count, 'dismissed');
            } catch (error) {
                console.error('Failed to load user prefs:', error);
            }
        }

        // =====================================================================
        // Export Functions
        // =====================================================================
        function exportToCSV() {
            if (filteredAccounts.length === 0) {
                alert('No accounts to export');
                return;
            }

            const headers = ['wallet', 'score', 'total_pnl', 'trades', 'max_drawdown', 'activity_days', 'trades_7d'];
            const rows = filteredAccounts.map(a => [
                a.wallet_address || a.wallet,
                a.systematic_score || 0,
                a.total_pnl || 0,
                a.num_trades || 0,
                a.max_drawdown_pct || a.estimated_drawdown_pct || 0,
                a.activity_recency_days ?? 999,
                a.trades_last_7d || 0
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `discovered_traders_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // =====================================================================
        // Initialize
        // =====================================================================
        updatePanelStates();
        document.getElementById('watchlist-count').textContent = watchlist.length;
        document.getElementById('watchlist-count-panel').textContent = watchlist.length;
        document.getElementById('dismissed-count').textContent = dismissed.length;

        // Load user preferences (dismissed list) from server
        loadUserPrefs();
    </script>
</body>
</html>
